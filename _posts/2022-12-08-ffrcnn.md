---
title : '[DL/CV] ê°ì²´ íƒì§€ - Faster RCNN ğŸ“¦'
layout : single
toc : true
toc: true
toc_sticky: true
categories:
  - cv-objectdetection
---
## Faster RCNN ë…¼ë¬¸ ì½ì–´ë³´ê¸°

### 0. í•µì‹¬ ì•„ì´ë””ì–´
Faster-RCNNì€ Real Time Object Detectionì˜ í¬ë¬¸ì„ ì—° ê¸°ë²•ì´ë¼ê³  í•  ìˆ˜ ìˆë‹¤. Faster-RCNNì˜ ê°€ì¥ í° íŠ¹ì§•ì€ ê·¸ë™ì•ˆ Selective Searchë¥¼ ì‚¬ìš©í•´ì„œ ê³„ì‚°í•´ì™”ë˜ Region Proposal ë‹¨ê³„ë¥¼ ì‹ ê²½ë§ì— í¬í•¨ì‹œì¼œì„œ Fast-RCNNë³´ë‹¤ ì™„ì „í•œ end-to-end ëª¨ë¸ì„ ì œì‹œí–ˆë‹¤.

Faster-RCNNì˜ í•µì‹¬ ì•„ì´ë””ì–´ëŠ” Region Proposal Network (RPN)ì´ë‹¤. ê¸°ì¡´ Fast-RCNNì—ì„œ selective searchë¥¼ ì—†ì• ê³  ëŒ€ì‹  RPNì„ ì‚¬ìš©í•´ì„œ RoIë¥¼ ê³„ì‚°í•œë‹¤. ë‹¤ìŒì€ Faster-RCNNì˜ ì „ë°˜ì ì¸ êµ¬ì¡°ì´ë‹¤.

ì´ë¯¸ì§€1

ê°œëµì ì¸ êµ¬ì¡°ë¥¼ ë³´ë©´ Fast-RCNNê³¼ ê°™ì´ CNNì„ í†µê³¼ì‹œì¼œì„œ Feature Mapì„ ì¶”ì¶œí•œ í›„ RPNì— ì „ë‹¬í•´ì„œ RoIë¥¼ ê³„ì‚°í•˜ëŠ” êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆë‹¤. 

### 1. Anchor Box
ë¨¼ì € RPNì— ì‚¬ìš©ë˜ëŠ” ì•„ì´ë””ì–´ì¸ Anchor boxì— ëŒ€í•´ì„œ ì•Œì•„ë³´ì. Selective Searchë¥¼ í†µí•´ region proposalì„ í•˜ì§€ ì•Šì„ ê²½ìš° ì›ë³¸ ì´ë¯¸ì§€ë¥¼ ì¼ì • ê°„ê²©ì˜ gridë¡œ ë‚˜ëˆ ì„œ grid cellì„ bounding boxë¡œ ê°„ì£¼í•´ì„œ feature mapì— encodeí•˜ëŠ” **Dense Sampling**ì„ ì‚¬ìš©í•œë‹¤. 

ì´ë¯¸ì§€2

í•˜ì§€ë§Œ ê³ ì •ëœ í¬ê¸°ì˜ bounding boxë¥¼ ì‚¬ìš©í•  ê²½ìš° ë‹¤ì–‘í•œ í¬ê¸°ì˜ ê°ì²´ë¥¼ í¬ì°©í•˜ì§€ ëª»í•  ìˆ˜ë„ ìˆë‹¤ëŠ” ë¬¸ì œê°€ ìˆë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì— ë…¼ë¬¸ì—ì„œëŠ” ë‹¤ì–‘í•œ í¬ê¸°ì™€ ê°€ë¡œì„¸ë¡œë¹„(ascept ratio)ë¥¼ ê°€ì§€ëŠ” bounding boxì¸ Anchor Boxë¥¼ ì‚¬ìš©í•œë‹¤. ë‹¤ìŒê³¼ ê°™ì´ 3ê°€ì§€ í¬ê¸°ì™€ 3ê°€ì§€ ë¹„ìœ¨ì„ ì‚¬ìš©í•´ì„œ 9ê°œì˜ ì„œë¡œ ë‹¤ë¥¸ anchor boxë¥¼ ì‚¬ì „ì— ì •ì˜í•œë‹¤.

ì´ë¯¸ì§€3

anchor boxëŠ” ì›ë³¸ ì´ë¯¸ì§€ì˜ ê° grid cellì˜ ì¤‘ì‹¬(anchor)ì„ ê¸°ì¤€ìœ¼ë¡œ ìƒì„±í•œë‹¤. ì›ë³¸ ì´ë¯¸ì§€ì—ì„œ sub-sampling ratioë¥¼ ì´ìš©í•´ì„œ ê°€ì „ì— ì •ì˜í•œ anchor box 9ê°œë¥¼ ìƒì„±í•œë‹¤. ë‹¤ìŒ ì´ë¯¸ì§€ì—ì„œ ì›ë³¸ ì´ë¯¸ì§€ì˜ í¬ê¸°ëŠ” 600x800, sub-sampling ratioëŠ” 1/16ì´ë‹¤. anchorì€ ì´ 1900(=600/16 x 800/16)ê°œì´ê³ , anchor boxëŠ” ì´ 17100(=1900x9)ê°œê°€ ìƒì„±ëœë‹¤. ì´ ë°©ì‹ì„ ì‚¬ìš©í•˜ë©´ ê³ ì •ëœ í¬ê¸°ì˜ bounding boxë¥¼ ì‚¬ìš©í•  ë•Œë³´ë‹¤ 9ë°° ë§ì€ bounding boxë¥¼ ìƒì„±í•˜ê³  ê·¸ ê²°ê³¼ ë” ë‹¤ì–‘í•œ í¬ê¸°ì˜ ê°ì²´ë¥¼ í¬ì°©í•  ìˆ˜ ìˆë‹¤.

### 2. Region Propsal Network (RPN)

ì›ë³¸ ì´ë¯¸ì§€ì—ì„œ anchor boxë¥¼ ìƒì„±í•˜ë©´ ìˆ˜ë§ì€ region proposalsê°€ ìƒì„±ëœë‹¤. RPNì€ region proposalsì— ëŒ€í•´ì„œ class scoreì„ ë§¤ê¸°ê³ , bounding box coefficientë¥¼ ì¶œë ¥í•œë‹¤. RPNì˜ ìì„¸í•œ ì•Œê³ ë¦¬ì¦˜ì„ ì•Œì•„ë³´ì.

ì´ë¯¸ì§€4

(ê´„í˜¸ì— ìˆëŠ” ë‚´ìš©ì€ ê° ê³¼ì •ì˜ ì˜ˆì‹œì´ë‹¤.)
1. ì›ë³¸ ì´ë¯¸ì§€ë¥¼ ì‚¬ì „ í›ˆë ¨ëœ VGG ëª¨ë¸ì— í†µê³¼ì‹œì¼œì„œ feature mapì„ ì–»ëŠ”ë‹¤. (ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸°ê°€ 800x800ì´ê³  sub-sampling ratioê°€ 1/100ì¼ë•Œ, 8x8 í¬ê¸°ì˜ feature ë§µì´ ìƒì„±ëœë‹¤.)
2. (1)ì—ì„œ ì–»ì€ feature mapì— ëŒ€í•´ì„œ 3x3 conv ì—°ì‚°ì„ ì ìš©í•˜ê³ , ì´ë•Œ feature mapì˜ í¬ê¸°ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ padding=1ì„ ì‚¬ìš©í•œë‹¤. (8x8x512 feature mapì— 3x3 ì—°ì‚°ì„ ì ìš©í•´ì„œ 8x8x512 feature mapì´ ì¶œë ¥ëœë‹¤.)
3. class scoreë¥¼ ë§¤ê¸°ê¸° ìœ„í•´ feature mapì— 1x1 conv ì—°ì‚°ì„ ì ìš©í•œë‹¤. ì—¬ê¸°ì„œ ì…ë ¥ ì´ë¯¸ì§€ì˜ í¬ê¸°ì— ìƒê´€ì—†ì´ ì‘ë™í•  ìˆ˜ ìˆë„ë¡ fully-connectedê°€ ì•„ë‹Œ Fully Convolution Networkë¥¼ ì‚¬ìš©í•œë‹¤.
4. RPNì—ì„œëŠ” í›„ë³´ ì˜ì—­ì´ ì–´ë–¤ classì— í•´ë‹¹í•˜ëŠ”ì§€ê¹Œì§€ëŠ” êµ¬ë¶„í•˜ì§€ ì•Šê³  ê°ì²´ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ ì—¬ë¶€ë§Œ ë¶„ë¥˜í•œë‹¤. ë”°ë¼ì„œ channel ìˆ˜ëŠ” 2(object ì¡´ì¬ ì—¬ë¶€) x 9(anchor box 9ê°œ)ê°€ ëœë‹¤. (8x8x512ì˜ feature mapì„ 8x8x2x9ì˜ feature mapìœ¼ë¡œ ì¶œë ¥í•œë‹¤.)
5. Bounding Box Regressionì„ ì–»ê¸° ìœ„í•´ feature mapì— 1x1 convë¥¼ ì ìš©í•œë‹¤. ì´ ë•Œ feature mapì˜ ì±„ë„ ìˆ˜ëŠ” 4(bounding box regressor) x 9(anchor box 9ê°œ)ê°€ ëœë‹¤.(8x8x512ì˜ feature mapì„ 8x8x4x9ì˜ feature mapìœ¼ë¡œ ì¶œë ¥í•œë‹¤.)

ì´ë¯¸ì§€5

RPNì˜ ì¶œë ¥ ê²°ê³¼ëŠ” ìœ„ì˜ í‘œì™€ ê°™ë‹¤. ì¢Œì¸¡ í‘œëŠ” ê°ì²´ í¬í•¨ ì—¬ë¶€(classification)ë¥¼ ë‚˜íƒ€ë‚¸ feature mapì´ê³ , ìš°ì¸¡ í‘œëŠ” anchor boxì˜ ì¢…ë¥˜ì— ë”°ë¼ bounding box regressorë¥¼ ë‚˜íƒ€ë‚¸ feature mapì´ë‹¤. 8x8 grid cellë§ˆë‹¤ 9ê°œì˜ anchor boxê°€ ìƒì„±ë˜ê¸° ë•Œë¬¸ì— 576ê°œì˜ region proposalsê°€ ì¶”ì¶œë˜ë©°, feature mapì„ í†µí•´ ê°ê°ì— ëŒ€í•œ ê°ì²´ í¬í•¨ ì—¬ë¶€ì™€ bounding box regressorë¥¼ íŒŒì•…í•  ìˆ˜ ìˆë‹¤. ì´ ì¤‘ ìƒìœ„ Nê°œì˜ region proposalë§Œ ì¶”ì¶œí•˜ê³  ì´ë¥¼ Non maximum suppressionì„ ì ìš©í•´ì„œ ìµœì ì˜ region proposalsë§Œì„ Fast-RCNNì— ì „ë‹¬í•œë‹¤.

### 3. Multi-task loss
RPNì—ì„œëŠ” classificationê³¼ Bounding Box Regressionì„ ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì— ì†ì‹¤ í•¨ìˆ˜ëŠ” ì´ ë‘ê°€ì§€ì—ì„œ ì–»ì€ ì†ì‹¤ì„ ì—®ì€ Multi-task Lossë¥¼ ì‚¬ìš©í•œë‹¤. 

ì´ë¯¸ì§€6

* i : mini-batchì—ì„œ anchorì˜ index
* pi : anchor iì— ê°ì²´ê°€ í¬í•¨ë˜ì–´ ìˆì„ ì˜ˆì¸¡ í™•ë¥ 
* pi* : anchorê°€ ì–‘ì„±ì¼ ê²½ìš° 1, ìŒì„±ì¼ ê²½ìš° 0
* ti : ì˜ˆì¸¡ bounding boxì˜ íŒŒë¼ë¯¸í„°í™”ëœ ì¢Œí‘œ(coefficient)
* ti* : ground truth boxì˜ coefficient
* Lcls : log lossë¥¼ í™œìš©í•œ classification loss í•¨ìˆ˜
* Lreg : Smooth L1 lossë¥¼ í™œìš©í•œ BBR loss í•¨ìˆ˜
* Ncls : mini-batch ì‚¬ì´ì¦ˆ (ë…¼ë¬¸ì—ì„œ 256)
* Nreg : anchor ìœ„ì¹˜ì˜ ìˆ˜
* Î» : Lcls ì™€ Lreg ì‚¬ì´ì— ê°€ì¤‘ì¹˜ë¥¼ ì¡°ì ˆ(ë…¼ë¬¸ì—ì„œ 10=ë™ì¼í•œ ê°€ì¤‘ì¹˜)

### 4. Faster RCNN í›ˆë ¨í•˜ê¸°

Faster RCNNì˜ í›ˆë ¨ ê³¼ì •ì€ ë‹¤ìŒ ì´ë¯¸ì§€ì™€ ê°™ì€ë°, ì‘ë™ ë°©ì‹ì´ ë³µì¡í•˜ê¸° ë•Œë¬¸ì— ê° layerë“¤ì„ ì„¤ëª…í•˜ë©´ì„œ ì‘ë™ ë°©ì‹ì„ ì•Œì•„ë³´ê² ë‹¤.

1) ì‚¬ì „ í›ˆë ¨ëœ VGG16

sub-sampling ratio = 1/16 ì„ ì‚¬ìš©í•´ì„œ feature extractionì„ ì§„í–‰í•œë‹¤.
* Input : 800x800x3 ì›ë³¸ ì´ë¯¸ì§€
* Process : feature extraction by pre trained VGG16
* Output : 50x50x512 feature map

2) Anchor generation layer

ì›ë³¸ ì´ë¯¸ì§€ì— ëŒ€í•´ì„œ anchor boxë¥¼ ìƒì„±í•œë‹¤.

* Input : 800x800x3 ì›ë³¸ ì´ë¯¸ì§€
* Process : anchor ìƒì„±
* Output : 22500(50x50x9)ê°œì˜ anchor boxes

3) RPN

class score, boudning box regressorë¥¼ ë°˜í™˜í•œë‹¤.
* Input : 50x50x512 feature map
* Process : Region proposal
* Output : 50x50x2x9 feature map(class score), 50x50x4x9 feature map(bounding box regressor)

4) Proposal layer

(2)ì—ì„œ ìƒì„±ëœ anchor boxesì™€ (3)ì—ì„œ ë°˜í™˜í•œ class scoresì™€ bounding box regressorë¥¼ ì´ìš©í•´ì„œ region proposalsë¥¼ ì¶”ì¶œí•œë‹¤. Non maximum suppressionì„ ì ìš©í•œ í›„, class score ìƒìœ„ Nê°œì˜ anchor boxë¥¼ ì¶”ì¶œí•œë‹¤. 
* Input : 22500 anchor boxes, class scores, bounding box regressors
* Process : region proposal by proposal layer 
* Output : top N-ranked region proposals

5) Anchor target layer

RPNì´ í•™ìŠµí•˜ëŠ”ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” anchorë¥¼ ì„ íƒí•œë‹¤. (2)ì—ì„œ ìƒì„±í•œ anchor boxì¤‘ì— ì›ë³¸ ì´ë¯¸ì§€ì˜ ê²½ê³„ë¥¼ ë²—ì–´ë‚˜ì§€ ì•ŠëŠ” anchor boxë¥¼ ì„ íƒí•˜ê³  ê°ì²´ê°€ ì¡´ì¬í•˜ëŠ” foregroundëŠ” positive, ê°ì²´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” backgroundëŠ” negativeë¡œ ë°ì´í„°ë¥¼ samplingí•œë‹¤.

ì „ì²´ anchor boxì¤‘ì—ì„œ ground truth boxì™€ ê°€ì¥ í° IoUë¥¼ ê°€ì§€ëŠ” ê²½ìš°ì™€ IoUê°€ 0.7 ì´ìƒì¸ ê²½ìš° positive, 0.3 ì´í•˜ì¸ ê²½ìš°ëŠ” negativeë¡œ ì„ ì •í•œë‹¤.(0.3~0.7 IoUëŠ” ë¬´ì‹œ)

* Input : anchor boxes, ground truth boxes
* Process : RPNì— ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” anchor ì„ íƒ
* Output : positive/negative samples with target regression coefficients

6) Proposal Target layer

Fast RCNNì„ í•™ìŠµì‹œí‚¤ê¸° ìœ ìš©í•œ sampleì„ ì„ íƒí•œë‹¤. region proposalsë“¤ê³¼ ground truth boxì™€ì˜ IoUë¥¼ ê³„ì‚°í•´ì„œ 0.5ì´ìƒì´ë©´ positive, 0.1~0.5ì¼ ê²½ìš° negative sampleë¡œ labelí•œë‹¤.

* Input : top N-ranked region proposals, ground truth boxes
* Process : select region proposals for training Fast RCNN
* Output : positive/negative samples with target regression coefficients

7) RoI Pooling

Fast RCNNì—ì„œ ì§„í–‰í–ˆë˜ Max Poolingì„ ì´ìš©í•œ RoI Poolingì„ ì§„í–‰í•œë‹¤.

* Input : 50x50x512 feature map, positive/negative samples with target regression coefficients
* Process : RoI Pooling
* Output : 7x7x512 feature map

8) Training Fast RCNN by Multi-task loss

ë‚˜ë¨¸ì§€ëŠ” Fast RCNNì˜ ë™ì‘ ìˆœì„œì™€ ë™ì¼í•˜ê²Œ ì§„í–‰ëœë‹¤. ì…ë ¥ ë°›ì€ feature mapì„ fc layerì— ì£¼ì…í•´ì„œ 4096í¬ê¸°ì˜ feature vectorë¥¼ ì–»ê³ , ì´ë¥¼ Classifierì™€ BBRì— ì£¼ì…í•´ì„œ (Kê°œì˜ í´ë˜ìŠ¤ë¼ê³  í•  ë•Œ) ê°ê° (K+1), (K+1)x4 í¬ê¸°ì˜ feature vectorë¥¼ ì¶œë ¥í•œë‹¤. ì¶œë ¥ëœ ê²°ê³¼ë¥¼ ì‚¬ìš©í•´ì„œ Fast RCNNì„ í•™ìŠµì‹œí‚¨ë‹¤.

* Input : 7x7x512 feature map
* Process : feature extraction, classification, BBR, train Fast RCNN by mulit task loss
* Output : loss (Log loss + Smooth L1 loss)

### 5. Alternating Training
ì „ì²´ ëª¨ë¸ì„ í•œë²ˆì— í•™ìŠµ ì‹œí‚¤ê¸°ì—ëŠ” êµ‰ì¥íˆ ì–´ë µë‹¤. RPNì´ ì œëŒ€ë¡œ RoIë¥¼ ê³„ì‚°í•˜ì§€ ëª»í•˜ëŠ”ë° ë’¤ì˜ Classification layerê°€ ì œëŒ€ë¡œ í•™ìŠµë˜ê¸°ëŠ” í˜ë“ ê²ƒì²˜ëŸ¼ ë§ì´ë‹¤. ê·¸ë˜ì„œ ì €ìëŠ” 4ë‹¨ê³„ì— ê±¸ì³ì„œ RPNê³¼ Fast RCNNì„ ë²ˆê°ˆì•„ì„œ í•™ìŠµì‹œí‚¤ëŠ” Alternating Training ê¸°ë²•ì„ ì‚¬ìš©í•œë‹¤.

ì´ë¯¸ì§€8

1. ë¨¼ì € Anchor generation layerì—ì„œ ìƒì„±ëœ anchor boxì™€ ground truth boxë¥¼ ì‚¬ìš©í•´ì„œ Anchor target layerì—ì„œ positive/negative ë°ì´í„°ì…‹ì„ êµ¬ì„±í•˜ê³  ì´ë¥¼ í™œìš©í•´ì„œ **RPNì„ í•™ìŠµ**ì‹œí‚¨ë‹¤. ì´ ê³¼ì •ì—ì„œ VGG16ë„ í•™ìŠµëœë‹¤.
2. Anchor generation layerì—ì„œ ì–»ì€ anchor boxì™€ í•™ìŠµëœ RPNì— ì›ë³¸ ì´ë¯¸ì§€ë¥¼ ì¤‘ë¹„í•´ì„œ ì–»ì€ feature mapì„ ì‚¬ìš©í•´ì„œ proposals layerì—ì„œ region proposalsë¥¼ ì¶”ì¶œí•˜ê³  ì´ë¥¼ Proposal traget layerì— ì „ë‹¬í•´ì„œ positive/negative ë°ì´í„° ì…‹ì„ êµ¬ì„±í•˜ê³  ì´ë¥¼ í™œìš©í•´ì„œ **Fast RCNNì„ í•™ìŠµ**ì‹œí‚¨ë‹¤. ì´ë•Œë„ VGG16ì´ í•™ìŠµëœë‹¤.
3. (1),(2)ì—ì„œ í•™ìŠµì‹œí‚¨ RPNê³¼ Fast RCNNì—ì„œ **RPNì— í•´ë‹¹í•˜ëŠ” ë¶€ë¶„í•œ fine tuning**ì‹œí‚¨ë‹¤. ì´ ê³¼ì •ì—ì„œëŠ” ë‘ ë„¤íŠ¸ì›Œí¬ë¼ë¦¬ ê³µìœ í•˜ëŠ” VGG16ì€ ë™ê²°(freeze)ì‹œí‚¨ë‹¤.
4. (3)ì—ì„œ í•™ìŠµì‹œí‚¨ RPNì„ í™œìš©í•´ì„œ ì¶”ì¶œí•œ region proposalsë¥¼ ì´ìš©í•´ì„œ **Fast RCNNì„ fine tuningì‹œí‚¨ë‹¤.** ì´ë•Œ RPNê³¼ VGG16ì€ ë™ê²°ì‹œí‚¨ë‹¤.

ìœ„ì˜ ê³¼ì •ì„ ì‰½ê²Œ ìƒê°í•˜ë©´ RPNê³¼ Fast RCNì„ ë²ˆê°ˆì•„ì„œ í•™ìŠµì‹œí‚¤ë©´ì„œ ê³µìœ ëœ convoluiton layerë¥¼ ì‚¬ìš©í•œë‹¤ê³  ìƒê°í•˜ë©´ ëœë‹¤.

### 6. Inference(Detection)

ì´ë¯¸ì§€9

inferene ì‹œì—ëŠ” ë„¤íŠ¸ì›Œí¬ë¥¼ í•™ìŠµì‹œí‚¤ê¸° ìœ„í•œ ë°ì´í„°ì…‹ì„ êµ¬ì„±í•˜ëŠ” layerì¸ Anchor target layerì™€ Proposal target layerëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤. InferenceëŠ” Proposal layerì—ì„œ ì¶”ì¶œí•œ region proposalì„ í™œìš©í•´ì„œ Fast RCNNì´ ìˆ˜í–‰í•œë‹¤. ê·¸ë¦¬ê³  ìµœì¢…ì ìœ¼ë¡œ ì–»ì€ predicted boxì— Non maximum suppressionì„ ì ìš©í•´ì„œ ìµœì ì˜ bounding boxë§Œì„ ê²°ê³¼ë¡œ ì¶œë ¥í•œë‹¤.


---
title : '[OD/ê°œë…] ê°ì²´ íƒì§€ - Mask R-CNN ğŸ­'
layout : single
toc : true
toc: true
toc_sticky: true
categories:
  - cv-objectdetection
---

## Mask R-CNN ë…¼ë¬¸ ì½ì–´ë³´ê¸°

ì´ë²ˆ ê¸€ì—ì„œëŠ” Mask R-CNN ë…¼ë¬¸ì„ ì½ê³  ë¦¬ë·°í•´ë³´ë„ë¡ í•˜ê² ë‹¤. Mask R-CNNì€ object detection ë³´ë‹¤ëŠ” instance segmantation taskì— ì£¼ë¡œ ì‚¬ìš©ë˜ëŠ” ëª¨ë¸ì´ë‹¤. ì§€ê¸ˆê¹Œì§€ ëŒ€ë¶€ë¶„ì˜ ê¸€ë“¤ì—ì„œ segmantationì— ëŒ€í•´ì„œ ë‹¤ë¤„ë³¸ ì ì´ ê±°ì˜ ì—†ìœ¼ë‹ˆ Instance Segmentationì— ëŒ€í•´ì„œ ê°„ë‹¨íˆ ì•Œì•„ë³´ì.

### 0. Instance Segmantation

![0](https://user-images.githubusercontent.com/77332628/218316087-608cbbd2-586a-42a1-9568-efc9c5bfc9b6.jpeg)

ìœ„ ì´ë¯¸ì§€ì—ì„œ (c)ëŠ” Semantic segmantationìœ¼ë¡œ í”½ì…€ ë‹¨ìœ„ë¡œ ê°ì²´ë¥¼ êµ¬ë¶„í•˜ëŠ” ê²ƒì¸ë°, ë™ì¼í•˜ê²Œ ë¶„ë¥˜ëœ ì¹´í…Œê³ ë¦¬ì˜ instanceëŠ” êµ¬ë¶„í•˜ì§€ ì•ŠëŠ”ë‹¤. ë°˜ë©´ì— (d) ì´ë¯¸ì§€ëŠ” Instance segmantationìœ¼ë¡œ ê°™ì€ ì¹´í…Œê³ ë¦¬ë¡œ ë¶„ë¥˜ëœ ê°ì²´ë”ë¼ë„ ë¶„ë¦¬í•´ì„œ íƒì§€í•œë‹¤. ì´ëŠ” object detectionê³¼ ê°ê°ì˜ í”½ì…€ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ë¶„ë¥˜í•˜ëŠ” semantic segmantationì´ ê²°í•©ëœ ê²ƒì´ë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤.

### 1. Mask branch

![2](https://user-images.githubusercontent.com/77332628/218316091-ef3ea8aa-c3ea-4db0-9466-b3b15603167e.jpeg)

Mask R-CNN ëª¨ë¸ì— ëŒ€í•´ì„œ ìì„¸íˆ ì•Œì•„ë³´ê¸° ì „ì— ê°œëµì ì¸ ëª¨ë¸ì˜ êµ¬ì¡°ë¥¼ ì•Œì•„ë³´ì. Mask R-CNNì€ Faster R-CNNì˜ RPNì—ì„œ ì–»ì€ RoIì— ëŒ€í•´ì„œ class classification branch, bbox regression branchì— segmantation maskë¥¼ ì˜ˆì¸¡í•˜ëŠ” **mask branchê°€ ì¶”ê°€**ëœ êµ¬ì¡°ë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤. ìœ„ ì´ë¯¸ì§€ì²˜ëŸ¼ mask branchëŠ” ê°ê°ì˜ RoIì— ì‘ì€ í¬ê¸°ì˜ FCN(Fully Convolutional Network)ì´ ì¶”ê°€ëœ í˜•íƒœì´ë‹¤. 

![3](https://user-images.githubusercontent.com/77332628/218316094-619e0740-8b93-4469-a58e-a5c4f1748d70.png)

Fster R-CNNê³¼ Mask R-CNNì˜ ì°¨ì´ì ì„ ì•Œì•„ë³´ê¸° ìœ„í•´ Faster R-CNNì˜ êµ¬ì¡°ë¥¼ ë‹¤ì‹œí•œë²ˆ ì‚´í´ë³´ì. Faster R-CNNì€ ìœ„ ì´ë¯¸ì§€ì™€ ê°™ì´ backbone networkì—ì„œ ì–»ì€ feature mapì„ RPNì— ì…ë ¥í•´ì„œ RoIë¥¼ ì–»ê³ , RoI poolingì„ í†µí•´ ê³ ì •ëœ í¬ê¸°ì˜ feature mapì„ ì–»ê³  ì´ë¥¼ fc layerì— ì…ë ¥í•œ í›„ classification branchì™€ bbox regression branchì— ì…ë ¥í•´ì„œ class labelê³¼ bbox offsetì˜ ë‘ ê°€ì§€ ê²°ê³¼ë¥¼ ë„ì¶œí•œë‹¤.

![4](https://user-images.githubusercontent.com/77332628/218316096-d80ff683-1bbf-4bcf-9af0-9532ec52ef7c.png)

Mask R-CNNì€ Faster R-CNNì˜ ë‘ branchì™€ í‰í–‰ìœ¼ë¡œ segmantation maskë¥¼ ì˜ˆì¸¡í•˜ëŠ” mask branchê°€ ì¶”ê°€ëœ êµ¬ì¡°ì´ë‹¤. (*ì°¸ê³ ë¡œ ìœ„ ì´ë¯¸ì§€ëŠ” ì •ì‹ Mask R-CNN êµ¬ì¡°ê°€ ì•„ë‹ˆë‹¤. Mask branchê°€ ì¶”ê°€ëœ ê²ƒì„ ì‹œê°ì ìœ¼ë¡œ ì´í•´í•˜ê¸° ìœ„í•œ ì´ë¯¸ì§€ë‹¤.*) Mask R-CNNì€ mask branchê°€ ì¶”ê°€ëœ ê²ƒ ì™¸ì—ë„ RoI poolin ëŒ€ì‹  **RoI align**ì„ í†µí•´ ì¶”ì¶œí•œ feature mapì„ ê° branchì— ì…ë ¥í•´ì„œ class label, bbox offsetê³¼ segmantation maskë¥¼ ì–»ëŠ”ë‹¤. ì—¬ê¸°ì„œ segmantation maskëŠ” classì— ë”°ë¼ ë¶„í• ëœ ì´ë¯¸ì§€ ì¡°ê°(segment)ì´ë‹¤. (RoI alignì€ ë’¤ì—ì„œ ë‹¤ë£¬ë‹¤.)

segmantation taskëŠ” í”½ì…€ ë‹¨ìœ„ë¡œ classë¥¼ ë¶„ë¥˜í•˜ëŠ” detection taskë³´ë‹¤ ë” ì •êµí•œ ì‘ì—…ì´ê¸° ë•Œë¬¸ì— spatial layout(ê³µê°„ì— ëŒ€í•œ ë°°ì¹˜ ì •ë³´)ë¥¼ í•„ìš”ë¡œ í•œë‹¤. ì´ë¥¼ ìœ„í•´ mask branchëŠ” ì—¬ëŸ¬ ê°œì˜ conv layerë¡œ êµ¬ì„±ëœ ì‘ì€ FCNì˜ êµ¬ì¡°ë¥¼ ëˆë‹¤.ì´ë¥¼ í†µí•´ class labelì´ë‚˜ bbox offsetê³¼ ë‹¬ë¦¬ maskëŠ” ì´ë¯¸ì§€ ë‚´ ê°ì²´ì— ëŒ€í•œ ê³µê°„ ì •ë³´ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ encodeí•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•˜ë‹¤.

![5](https://user-images.githubusercontent.com/77332628/218316099-73cbb2d8-b22f-4092-8aaf-1267a646cfa2.jpeg)

mask branchëŠ” ê°ê°ì˜ RoIì— ëŒ€í•´ classë³„ë¡œ binary makë¥¼ ì¶œë ¥í•œë‹¤. ê¸°ì¡´ì˜ instance segmentation ëª¨ë¸ì€ í•˜ë‚˜ì˜ ì´ë¯¸ì§€ì—ì„œ ì—¬ëŸ¬ classë¥¼ ì˜ˆì¸¡í•œ ë°˜ë©´, Mask R-CNNì€ class ë³„ë¡œ maskë¥¼ ìƒì„±í•œ í›„ í”½ì…€ì´ í•´ë‹¹ classì— í•´ë‹¹í•˜ëŠ”ì§€ ì•ˆí•˜ëŠ”ì§€ì˜ ì—¬ë¶€ë§Œ í‘œì‹œí•œë‹¤. ì´ëŠ” classification branchê°€ ì˜ì¡´í•˜ëŠ” ê¸°ë³¸ê³¼ ë°©ì‹ê³¼ ë°˜ëŒ€ì´ë‹¤. ì¦‰ mask branchì™€ classification branchë¥¼ ë¶„ë¦¬ì‹œì¼°ë‹¤ëŠ” ê²ƒì´ë‹¤. ë…¼ë¬¸ì—ì„œëŠ” ë‘ branchë¥¼ ê²°í•©í•  ê²½ìš° ì„±ëŠ¥ì´ í¬ê²Œ í•˜ë½í–ˆë‹¤ê³  í•œë‹¤.


![00](https://user-images.githubusercontent.com/77332628/218316089-5feffa11-c82a-44da-a3e6-0565f8799b7c.png)
 

mask branchëŠ” ìµœì¢…ì ìœ¼ë¡œ $Km^2$ í¬ê¸°ì˜ feature mapì„ ì¶œë ¥í•œë‹¤. ì—¬ê¸°ì„œ mì€ feature mapì˜ í¬ê¸°ì´ê³ , KëŠ” classìˆ˜ë¥¼ ì˜ë¯¸í•œë‹¤. ìœ„ ì´ë¯¸ì§€ì—ì„œ 14x14x80 í¬ê¸°ì˜ feature mapì„ ì¶œë ¥í–ˆëŠ”ë°, ë…¼ë¬¸ì—ì„œ COCO ë°ì´í„°ì…‹ì„ ì´ìš©í–ˆê¸° ë•Œë¬¸ì— 80ê°œì˜ classë¥¼ ê°€ì ¸ì„œ K=80ì´ê³  m=14ì´ë‹¤. ì´í›„ post-processing ê³¼ì •ì´ ìˆëŠ”ë°, ì´ëŠ” ë’· ë¶€ë¶„ì—ì„œ ë‹¤ë£¨ê² ë‹¤.




### 2. RoI Align

RoI poolingì„ ì‚¬ìš©í•˜ë©´ ì…ë ¥ ì´ë¯¸ì§€ í¬ê¸°ì™€ ìƒê´€ì—†ì´ ê³ ì •ëœ í¬ê¸°ì˜ feature mapì„ ì–»ì„ ìˆ˜ ìˆë‹¤ëŠ” ì´ì ì´ ìˆë‹¤. í•˜ì§€ë§Œ ë…¼ë¬¸ì—ì„œëŠ” RoI poolingìœ¼ë¡œ ì–»ì€ feature mapê³¼ RoI ì‚¬ì´ê°€ ì–´ê¸‹ë‚˜ëŠ” **misalignment**ê°€ ë°œìƒí•œë‹¤ê³  ì£¼ì¥í•œë‹¤. ì´ misalignmentëŠ” pixel maskë¥¼ ì˜ˆì¸¡í•˜ëŠ”ë° ë§¤ìš° ì•ˆì¢‹ì€ ì˜í–¥ì„ ë¼ì¹œë‹¤ê³  í•œë‹¤. ê·¸ë˜ì„œ ë…¼ë¬¸ì—ì„œëŠ” RoI pooling ëŒ€ì‹  **RoIAlign**ì´ë¼ëŠ” ë°©ë²•ì„ ì œì‹œí•œë‹¤. 

![6](https://user-images.githubusercontent.com/77332628/218316101-03a62f13-454a-4b91-9894-61e1a245a76b.png)

ë¨¼ì € RoI poolingì˜ ë°©ì‹ì„ ì‚´í´ë³´ì. ìœ„ ì´ë¯¸ì§€ì˜ ê²½ìš° RoIì˜ í¬ê¸°ëŠ” 145 x 200ì´ê³ , feature mapì€ 16x16ì´ë‹¤. ì´ëŠ” sub sampling ratio(=32)ì— ë§ê²Œ ë‚˜ëˆ ì£¼ë©´ projectionì„ ìˆ˜í–‰í•œ feature mapì€ ì•½ 4.53 x 6.25ì˜ í¬ê¸°ë¥¼ ê°€ì§€ê²Œ ëœë‹¤. í”½ì…€ê°’ì€ ì •ìˆ˜ê°’ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— 4x6 í¬ê¸°ì˜ feature mapì„ ì–»ê²Œ ëœë‹¤. ì´í›„ 3x3ì˜ ê³ ì •ëœ í¬ê¸°ì˜ feature mapì„ ì–»ê¸° ìœ„í•´ 4x6 í¬ê¸°ì˜ RoIì— ëŒ€í•´ì„œ RoI poolingì„ ìˆ˜í–‰í•œë‹¤. ì´ ê³¼ì •ì—ì„œ ê³ ì •ëœ í¬ê¸°ì— ë§ì¶”ê¸° ìœ„í•´ strideëŠ” 1x2ë¡œ ì„¤ì •ëœë‹¤. ì´ë¥¼ í†µí•´ ìµœì¢…ì ìœ¼ë¡œ 3x3 í¬ê¸°ì˜ feature mapì´ ì¶œë ¥ëœë‹¤.

![7](https://user-images.githubusercontent.com/77332628/218316104-31f67455-1dd9-4a1b-ad8b-09a37d330eb5.png)

ë…¼ë¬¸ì—ì„œëŠ” RoI poolingì´ quantizationì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— misalignmentë¥¼ ìœ ë„í•œë‹¤ê³  í•œë‹¤. quantizationì€ ì‹¤ìˆ˜ ì…ë ¥ê°’ì„ ì •ìˆ˜ì™€ ê°™ì€ ì´ì‚° ìˆ˜ì¹˜(discrete value)ë¡œ ì œí•œí•˜ëŠ” ë°©ë²•ì´ë‹¤. ìœ„ ê·¸ë¦¼ì²˜ëŸ¼ quantizationìœ¼ë¡œ ì¸í•´ì„œ RoI poolingì‹œì— ì •ë³´ê°€ ì†Œì‹¤ëœë‹¤. ì™¼ìª½ ì´ë¯¸ì§€ì²˜ëŸ¼ RoI projectionì„ ìˆ˜í–‰í•˜ëŠ” ê³¼ì •ì—ì„œ ì´ˆë¡ìƒ‰ê³¼ íŒŒë€ìƒ‰ ì˜ì—­ì— ëŒ€í•œ ì •ë³´ê°€ ì†ì‹¤ëœë‹¤. ì¶”ê°€ì ìœ¼ë¡œ ì˜¤ë¥¸ìª½ ê·¸ë¦¼ì—ì„œì²˜ëŸ¼ RoI poolingì‹œ strideë¥¼ ë°˜ì˜¬ë¦¼í•˜ê²Œ ë˜ë©´ì„œ feature mapì˜ ë§ˆì§€ë§‰ row(í•˜ëŠ˜ìƒ‰)ì— ëŒ€í•œ ì •ë³´ë„ ì†Œì‹¤ëœë‹¤.

quantizationìœ¼ë¡œ ì¸í•œ misalignmentëŠ” translation invariantí•œ classification taskì—ëŠ” í° ì˜í–¥ì´ ì—†ê¸° ë•Œë¬¸ì— Faster R-CNNì—ì„œëŠ” ë³„ ë¬¸ì œê°€ ì—†ì—ˆì§€ë§Œ, pixel ë‹¨ìœ„ë¡œ maskë¥¼ ì˜ˆì¸¡í•˜ëŠ” segmentation taskì—ëŠ” í° ì•…ì˜í–¥ì„ ë¯¸ì¹œë‹¤. ë…¼ë¬¸ì—ì„œëŠ” RoIAlign ë°©ë²•ìœ¼ë¡œ ì´ë¥¼ í•´ê²°í•œë‹¤. RoIAlignì€ ë‹¤ìŒê³¼ ê°™ì´ ë™ì‘í•œë‹¤.

![8](https://user-images.githubusercontent.com/77332628/218316107-45b6b4b7-3394-43ec-a039-f6ab59f624b6.png)

1. RoI projectionì„ í†µí•´ ì–»ì€ feature mapì„ quantization ì—†ì´ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•œë‹¤. ê·¸ ë‹¤ìŒ ì¶œë ¥í•  feature mapì˜ í¬ê¸°ì— ë§ê²Œ projectionëœ feature mapì„ ë¶„í• í•´ì¤€ë‹¤. ìœ„ ì˜ˆì‹œì—ì„œëŠ” 3x3 feature mapì„ ì¶œë ¥í•  ê²ƒì´ê¸° ë•Œë¬¸ì— widthì™€ heightë¥¼ ê°ê° 3ë“±ë¶„ í•´ì¤€ë‹¤.

2. ë¶„í• ëœ í•˜ë‚˜ì˜ cellì—ì„œ 4ê°œì˜ sampling pointë¥¼ ì¡ëŠ”ë‹¤. ì´ëŠ” cellì˜ heightì™€ widthë¥¼ ê°ê° 3ë“±ë¶„í•˜ëŠ” ì ì— í•´ë‹¹í•œë‹¤.

3. Bilinear interpolationì„ í†µí•´ì„œ sampling pointì˜ ê°’ì„ ì°¾ëŠ”ë‹¤. 

![9](https://user-images.githubusercontent.com/77332628/218316108-1a37bbf7-b55d-425f-956a-c9eacab8bde4.png)

ì´ë¥¼ êµ¬í•˜ëŠ” ê³µì‹ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

![10](https://user-images.githubusercontent.com/77332628/218316109-7d529b90-d730-4b59-a781-8dd597cf0c6e.png)

ìœ„ ê³µì‹ì—ì„œ $x,x_1,x_2,y,y_1,y_2$ëŠ” 2)ê³¼ì •ì—ì„œ ì–»ì€ 4ê°œì˜ sampling point ì¢Œí‘œì´ë©°, $Q_{11},Q_{21},Q_{12},Q_{22}$ëŠ” sampling pointì— ì¸ì ‘í•œ cellì˜ ê°’ì´ë‹¤. ìœ„ ê³µì‹ì— ë”°ë¼ ì…ë ¥ëœ featureì˜ ê°ê° RoI binì˜ 4ê°œì˜ sampled locationì„ ì—°ì‚°í•œë‹¤.

4. ìœ„ ê³¼ì •ì„ ëª¨ë“  cellì— ë°˜ë³µí•´ì„œ ì ìš©í•œë‹¤.

![11](https://user-images.githubusercontent.com/77332628/218316111-59c5ae39-1530-48b1-901c-de45abee3095.png)

5. ë§ˆì§€ë§‰ìœ¼ë¡œ í•˜ë‚˜ì˜ cellì— ìˆëŠ” 4ê°œì˜ sampling pointì— ëŒ€í•´ max poolingì„ ìˆ˜í–‰í•œë‹¤.

![12](https://user-images.githubusercontent.com/77332628/218316113-73d6db8f-f2d5-492f-833f-499ff366f80c.png)

ìœ„ ê³¼ì •ì˜ RoIAlignì„ í†µí•´ì„œ featureì™€ RoI ì‚¬ì´ê°€ ì–´ê¸‹ë‚˜ëŠ” misalignmentë¥¼ í•´ê²°í•˜ê³  ê²°ê³¼ì ìœ¼ë¡œ RoIì˜ ì •í™•í•œ spatial locationì„ ë³´ì¡´í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•´ì§„ë‹¤. ì´ ë³€í™”ë¥¼ í†µí•´ì„œ mask accuracyê°€ í¬ê²Œ í–¥ìƒëœë‹¤ê³  í•œë‹¤.

### 3. Loss function

![13](https://user-images.githubusercontent.com/77332628/218316114-3469ab02-e01d-4702-a9c3-53e5995c5ae2.png)

Mask R-CNNì€ ìœ„ì™€ ê°™ì´ êµ¬ì„±ëœ multi-task loss functionì„ í†µí•´ì„œ ë„¤íŠ¸ì›Œí¬ë¥¼ í•™ìŠµì‹œí‚¨ë‹¤. $L_{cls}$ì™€ $L_{box}$ëŠ” ê°ê° classificationê³¼ bounding box lossë¡œ Faster R-CNNê³¼ ë™ì¼í•˜ë‹¤. $L_{mask}$ëŠ” mask lossë¡œ **binary cross entropy** lossì´ë‹¤. mask branchì—ì„œ ì¶œë ¥í•œ $Km^2$ í¬ê¸°ì˜ feature mapì˜ ê° cellì— sigmoid functionì„ ì ìš©í•´ì„œ lossë¥¼ êµ¬í•œë‹¤.

ê¸°ì¡´ì˜ segmantation ëª¨ë¸ì€ í”½ì…€ë³„ë¡œ ì„œë¡œ ë‹¤ë¥¸ classë¥¼ softmax loss functionì„ ì‚¬ìš©í–ˆì§€ë§Œ, Mask R-CNNì€ class branchì™€ mask branchë¥¼ ë¶„ë¦¬í•´ì„œ classë³„ë¡œ maskë¥¼ ìƒì„±í•˜ê¸° ë•Œë¬¸ì— binary lossë¥¼ êµ¬í•œë‹¤.



### 4. Training Mask R-CNN

1) **Input image Pre-processing**

ì›ë³¸ ì´ë¯¸ì§€ê°€ width, height ì¤‘ ë” ì§§ì€ ìª½(shorter edge)ì˜ ê¸¸ì´ì¸ 800 pixelë¡œ resizeëœë‹¤. 

* Input : image
* Process : image pre-processing
* Output : resized-image

2) **Feature extraction by backbone network**

![14](https://user-images.githubusercontent.com/77332628/218316115-477d8b6a-1b85-4955-8ef4-e2d2d5b2578d.jpeg)

ì „ì²˜ë¦¬ëœ ì´ë¯¸ì§€ë¥¼ ResNet-FPN backbone networkì— ì…ë ¥í•´ì„œ feature pyramid {P2, P3, P4, P5}ë¥¼ ì–»ëŠ”ë‹¤. (FPNì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì€ [<U>FPN ë…¼ë¬¸ ë¦¬ë·°</U>](https://hamin-chang.github.io/cv-objectdetection/fpn/)ë¥¼ ì°¸ê³ í•˜ê¸¸ ë°”ë€ë‹¤.

* Input : resized image
* Process : constructing feature pyramid
* Output : feature pyramid {P2, P3, P4, P5}

3) **Region proposal by RPN**

(2)ì—ì„œ ì–»ì€ feature pyramidë³„ë¡œ RPNì— ì…ë ¥í•´ì„œ objectness scoreê³¼ bbox regressorë¥¼ ê°€ì§„ Region proposalì„ ì¶œë ¥í•œë‹¤. 

(*ì´ ê³¼ì •ì—ì„œ Anchor generation layerê°€ ìƒëµë˜ì–´ ìˆë‹¤.* ìì„¸í•œ ê³¼ì •ì€  [<U>Faster R-CNNë…¼ë¬¸ ë¦¬ë·°</U>](https://hamin-chang.github.io/cv-objectdetection/ffrcnn/)ë¥¼ ì°¸ê³ í•˜ê¸¸ ë°”ë€ë‹¤.)

* Input : feature pyramid {P2, P3, P4, P5} 
* Process : Region proposal
* Output :  Region proposals with objectness score and bbox regressor per feature pyramid {P2, P3, P4, P5}

4) **Select best RoI by Proposal layer**
 
ê·¸ ë‹¤ìŒ RPNìœ¼ë¡œ ì–»ì€ RoI ì¤‘ ìµœì ì˜ RoIë¥¼ ì„ ì •í•œë‹¤. ì´ ê³¼ì •ì€ Faster R-CNNì˜ Proposal layer, Anchor target layer, Proposal target layerì—ì„œ ìˆ˜í–‰í•˜ëŠ” ê³¼ì •ì´ë‹¤.

1. objectness scoreê°€ ë†’ì€ ìƒìœ„ Kê°œì˜ anchorë¥¼ ì„¤ì •í•œë‹¤.
2. bbox regressorì— ë”°ë¼ anchor boxì˜ í¬ê¸°ë¥¼ ì¡°ì •í•˜ê³ , ì´ë¯¸ì§€ ê²½ê³„ë¥¼ ë²—ì–´ë‚˜ëŠ” anchor boxëŠ” ì œê±°í•œë‹¤.
3. threshold = 0.7ë¡œ ì§€ì •í•´ì„œ NMSë¥¼ ìˆ˜í–‰í•œë‹¤.
4. 1~3ì˜ ê³¼ì •ì€ ê°ê°ì˜ feature pyramid levelë³„ë¡œ ìˆ˜í–‰ë˜ì—ˆë‹¤. ëª¨ë“  feature pyramid levelì˜ anchor boxì— ëŒ€í•œ ì •ë³´ë¥¼ concatenateí•´ì¤€ë‹¤.
5. ê²°í•©ëœ ëª¨ë“  anchor boxì— ëŒ€í•´ì„œ objectness scoreì— ë”°ë¼ ìƒìœ„ Nê°œì˜ anchor boxë¥¼ ì„ ì •í•´ì„œ ì´ë¥¼ í•™ìŠµì— ì‚¬ìš©í•œë‹¤.

* Input : Region proposals 
* Process : selecting top-N RoIs
* Output : top-N RoIs

5) **RoI Align**

backbone networkë¥¼ í†µí•´ multi-scale feature map {P2,P3,P4,P5}ê°€ ìƒì„±ë˜ê¸° ë•Œë¬¸ì— RoIë¥¼ ì–´ë–¤ scaleì˜ feature mapê³¼ ë§¤ì¹­ì‹œí‚¬ì§€ë¥¼ ê²°ì •í•´ì•¼í•œë‹¤. ì•„ë˜ì˜ ê³µì‹ì„ í†µí•´ì„œ ì´ë¥¼ ê²°ì •í•œë‹¤. ê·¸ë¦¬ê³  ë‚˜ì„œ RoIAlignì„ ìˆ˜í–‰í•´ì„œ feature mapì„ ì¶œë ¥í•œë‹¤.

![14](https://user-images.githubusercontent.com/77332628/218316116-5b0e3b49-a26d-4dfc-a5f5-5b00d8b161aa.png)

* Input : feature pyramid, RoIs 
* Process : RoIAlign
* Output : 7x7 sized feature map

6) **Classification and Bounding box regression** 

![15](https://user-images.githubusercontent.com/77332628/218316117-953d3f58-c990-4f42-b5c7-55982223a122.png)

* Input : 7x7 sized feature map
* Process : classification by classification branch, bbox regressor by bbox regression branch
* Output : class scores and bbox regressors





7) **Mask segment by Mask branch**

![17](https://user-images.githubusercontent.com/77332628/218316123-6d73ea68-b335-4a3d-b479-1276b78f6c88.jpeg)
![18](https://user-images.githubusercontent.com/77332628/218316125-e349bc6c-020c-4b50-90e0-3b99b0045185.jpeg)

mask branchëŠ” 3x3 conv - ReLU - deconv(by 2) - 1x1(xK) conv layerë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤. ì—¬ê¸°ì„œ KëŠ” class ìˆ˜ì´ë‹¤. ì´ë¥¼ í†µí•´ 14x14(xK) í¬ê¸°ì˜ feature mapì„ ì–»ì„ ìˆ˜ ìˆë‹¤. í•´ë‹¹ feature mapì€ class ë³„ë¡œ ìƒì„±ëœ binary maskì´ë‹¤. ë‹¤ìŒ ì´ë¯¸ì§€ì—ì„œì²˜ëŸ¼ backbone modelì— ë”°ë¼ ë‹¤ë¥¸ headë¥¼ ì‚¬ìš©í•œë‹¤.

![16](https://user-images.githubusercontent.com/77332628/218316120-b1c82b1a-8e98-49e0-9274-f88b0f16d719.png)

14x14(xK) feature map ì¤‘ ì•ì„œ classification branchì—ì„œ ì–»ì€ ê°€ì¥ ë†’ì€ scoreì˜ classì— í•´ë‹¹í•˜ëŠ” feature mapì„ ì„ ì •í•´ì„œ ìµœì¢… predictionì— ì‚¬ìš©í•œë‹¤. ì¦‰, ë‹¨ í•˜ë‚˜ì˜ 14x14 feature mapì´ ì„ ì •ëœë‹¤ëŠ” ê²ƒì´ë‹¤. ì´í›„ feature mapì˜ ê° cellë³„ë¡œ sigmoid í•¨ìˆ˜ë¥¼ ì ìš©í•´ì„œ 0~1 ì‚¬ì´ì˜ ê°’ì„ ì¶œë ¥í•˜ë„ë¡í•œë‹¤.

* Input : 7x7 sized feature map  
* Process : mask segment by mask branch
* Output : 14x14 sized feature map

8) **Post-processing of masks**

![19](https://user-images.githubusercontent.com/77332628/218316127-174ecd27-6db6-4bab-a0f2-33302b629c15.jpeg)


ìµœì¢…ì ìœ¼ë¡œ ì„ ì •ëœ 14x14 feature mapì„ ì›ë³¸ ì´ë¯¸ì§€ì˜ maskì™€ ë¹„êµí•˜ê¸° ìœ„í•´ ì›ë³¸ ì´ë¯¸ì§€ì— ë§ê²Œ rescaleí•´ì¤€ë‹¤. ì´í›„ threshold(=0.5)ì— ë”°ë¼ mask segmentì˜ ê° í”½ì…€ê°’ì´ 0.5 ì´ìƒì¸ ê²½ìš° classì— í•´ë‹¹í•˜ëŠ” ê°ì²´ê°€ ìˆì–´ 1ì„ í• ë‹¹í•˜ê³ , threshold ë¯¸ë§Œì˜ ê²½ìš° 0ì„ í• ë‹¹í•œë‹¤.

* Input : 14x14 sized feature map
* Process : rescale and apply mask threshold
* Output : mask segment

9) Train by multi-task loss

ìœ„ì—ì„œ ì–¸ê¸‰í•œ multi-task loss functionìœ¼ë¡œ Mask R-CNNì„ í•™ìŠµì‹œí‚¨ë‹¤.



### 5. Inferene & ê²°ë¡ 

Inference ì‹œì— Proposal layer êµ¬ê°„ì—ì„œ ëª¨ë“  feature pyramid levelì— ê±¸ì³ ìƒìœ„ 1000ê°œì˜ RoIë§Œì„ ì„ ì •í•œ í›„ RoIë¥¼ classification branchì™€ bbox regression branchì— ì…ë ¥í•˜ì—¬ ë‚˜ì˜¨ ì˜ˆì¸¡ ê²°ê³¼ì— Non maximum suppressionì„ ì ìš©í•˜ê³ , ìƒìœ„ 100ê°œì˜ boxë§Œì„ ì„ ì •í•˜ì—¬ mask branchì— ì…ë ¥í•œë‹¤. ì´ëŸ¬í•œ ì¶”ë¡  ê³¼ì •ì€ í•™ìŠµê³¼ì •ì²˜ëŸ¼ 3ê°œì˜ branchê°€ í‰í–‰í•˜ì§€ëŠ” ì•Šì§€ë§Œ, inference ì‹œê°„ì„ ì¤„ì—¬ì£¼ê³  ì •í™•ë„ê°€ ë” ë†’ê²Œ ë‚˜ì˜¨ë‹¤ëŠ” ì¥ì ì´ ìˆë‹¤ê³  í•œë‹¤.


Mask R-CNNì€ ResNeXt-101-FPNì„ backbone networkë¡œ ì‚¬ìš©í•˜ì—¬ COCO ë°ì´í„°ì…‹ì„ í•™ìŠµì— ì‚¬ìš©í•œ ê²°ê³¼, APê°’ì´ 37.1%ë¥¼ ë³´ì˜€ë‹¤. Instance segmentationì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ëª¨ë¸ì´ì–´ì„œ ì¡°ê¸ˆì€ ì–´ë ¤ì›Œ ë³´ì˜€ì§€ë§Œ ê²°êµ­ object detectionì„ í•˜ëŠ” ì›ë˜ì˜ Faster R-CNN ëª¨ë¸ì— semantic segmentation ì—­í• ì„ í•˜ëŠ” mask branchë§Œ ì¶”ê°€í•œ ê²ƒì´ë¼ëŠ” ê²ƒì„ ì•Œê³  ë‚˜ì„œëŠ” ì‰½ê²Œ ì´í•´í•œê²ƒ ê°™ë‹¤.

ì¶œì²˜ ë° ì°¸ê³ ë¬¸í—Œ 

ê°œì¸ ë¸”ë¡œê·¸1 (http://herbwood.tistory.com/20)

ê°œì¸ ë¸”ë¡œê·¸2 (https://blahblahlab.tistory.com/139)

Mask R-CNN ë…¼ë¬¸ (https://arxiv.org/pdf/1703.06870.pdf)

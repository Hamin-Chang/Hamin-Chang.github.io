---
title : '[DL/CV] ê°ì²´ íƒì§€ - Fast RCNN ğŸ“¦'
layout : single
toc : true
toc: true
toc_sticky: true
categories:
  - cv-objectdetection
---

## Fast RCNN ë…¼ë¬¸ ì½ì–´ë³´ê¸°

### 0. í•µì‹¬ ì•„ì´ë””ì–´

![frcnn1](https://user-images.githubusercontent.com/77332628/206882252-051aaced-7b01-4c69-9629-82e69c01eb32.png)

RCNN ëª¨ë¸ì€ 2000ì¥ì˜ Region Proposalsì„ CNNì— ì£¼ì…í•´ì„œ ê°ê°ì˜ Region Proposalì— ëŒ€í•´ì„œ ë…ë¦½ì ìœ¼ë¡œ í•™ìŠµì‹œí‚¤ê¸° ë•Œë¬¸ì— ë§ì€ ì‹œê°„ì´ ì†Œìš”ëœë‹¤. ì´ëŸ° ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ Fast RCNNì€ **ë‹¨ 1ì¥ì˜ ì´ë¯¸ì§€**ë§Œ ì…ë ¥ì„ ë°›ìœ¼ë©° Region Proposalsì˜ í¬ê¸°ë¥¼ warp ì‹œí‚¬ í•„ìš” ì—†ëŠ” RoI Poolingì„ í†µí•´ ê³ ì •ëœ í¬ê¸°ì˜ feature vectorì„ ì¶œë ¥í•´ì„œ fc layerì— ì „ë‹¬í•œë‹¤. ê·¸ë¦¬ê³  multi-taks lossë¥¼ ì‚¬ìš©í•´ì„œ ëª¨ë¸ì„ ê°œë³„ì ìœ¼ë¡œ í•™ìŠµì‹œí‚¬ í•„ìš”ì—†ì´ í•œë²ˆì— í•™ìŠµì‹œí‚¤ê¸° ë•Œë¬¸ì— ì†ë„ë„ ë¹¨ë¼ì¡Œë‹¤. 

### 1. RoI Pooling
RoI Poolingì€ feature mapì—ì„œ region proposalsì— í•´ë‹¹í•˜ëŠ” ê´€ì‹¬ì˜ì—­(RoI)ì„ ì§€ì •í•œ í¬ê¸°ì˜ gridë¡œ ë‚˜ëˆˆ í›„ max poolingì„ í•˜ëŠ” ê¸°ë²•ì´ë‹¤. ê° ì±„ë„ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ìˆ˜í–‰í•˜ë©°, RoI poolingì„ í†µí•´ì„œ **ê³ ì •ëœ í¬ê¸°ì˜ feature mapì„ ì¶œë ¥**í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•˜ë‹¤. RoIì˜ êµ¬ì²´ì ì¸ ê³¼ì •ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

![frcnn2](https://user-images.githubusercontent.com/77332628/206882255-1a02c3a0-36a6-454a-9a18-4f4f32769b0d.jpeg)

(ê´„í˜¸ ì•ˆì˜ ë‚´ìš©ì€ ê° ê³¼ì •ì˜ ì˜ˆì‹œë‹¤.)

1) ì›ë³¸ ì´ë¯¸ì§€ë¥¼ pre-trained CNN ëª¨ë¸ì— ì£¼ì…í•´ì„œ feature mapì„ ì–»ëŠ”ë‹¤. (800x800 ì´ë¯¸ì§€ë¥¼ VGG ëª¨ë¸ì— ì£¼ì…í•´ì„œ 8x8 feature mapì„ ì–»ëŠ”ë‹¤. ì´ë•Œ sub-sampling ratio = 1/100ì´ë‹¤.)

2) ë™ì‹œì— ì›ë³¸ ì´ë¯¸ì§€ì— Selective searchë¥¼ ì ìš©í•´ì„œ region proposalsì„ ì–»ëŠ”ë‹¤. (ì›ë³¸ ì´ë¯¸ì§€ì— selective searchë¥¼ ì ìš©í•´ì„œ 500x700í¬ê¸°ì˜ region proposalsë¥¼ ì–»ëŠ”ë‹¤.)

3) (1)ì˜ feature mapì—ì„œ ê°region proposalsì— í•´ë‹¹í•˜ëŠ” ì˜ì—­ì„ ì¶”ì¶œí•œë‹¤. feature mapì€ sub-samplingì„ í†µí•´ í¬ê¸°ê°€ ì‘ì•„ì§„ ë°˜ë©´, region proposalsì€ í¬ê¸°ê°€ ì‘ì•„ì§€ì§€ ì•Šì•˜ë‹¤. ë”°ë¼ì„œ region proposalsì˜ í¬ê¸°ì™€ ì¤‘ì‹¬ ì¢Œí‘œë¥¼ sub-sampling ratioì— ë§ê²Œ ë³€ê²½ì‹œì¼œì„œ ì‘ì•„ì§„ **feature mapì—ì„œ region propsalsê°€ encode(í‘œí˜„)í•˜ê³  ìˆëŠ” ë¶€ë¶„ì„ ì°¾ê¸° ìœ„í•´ feature mapì— ë§ê²Œ region proposalsë¥¼ íˆ¬ì˜**í•˜ëŠ” **RoI Projection**ì„ ìˆ˜í–‰í•œë‹¤. (feature mapì—ì„œ region proposalsì— í•´ë‹¹í•˜ëŠ” 5x7 ì˜ì—­ì„ ì¶”ì¶œí•œë‹¤.)

4) ì¶”ì¶œí•œ RoI feature mapì„ ì§€ì •í•œ sub-window í¬ê¸°ì— ë§ê²Œ gridë¡œ ë‚˜ëˆˆë‹¤.(ì¶”ì¶œí•œ 5x7ì˜ì—­ì„ ì§€ì •í•œ 2x2í¬ê¸°ì— ë§ê²Œ gridë¥¼ ë‚˜ëˆˆë‹¤.)

5) gridì˜ ê° ì…€ì— max-poolingì„ ì ìš©í•´ì„œ **ê³ ì •ëœ í¬ê¸°ì˜ feature mapì„ ì¶”ì¶œ**í•œë‹¤.

### 2. Multi Task Loss
RoI Poolingì„ í†µí•´ì„œ feature vectorë¥¼ êµ¬í–ˆë‹¤, ì´ì œëŠ” ì´ ë²¡í„°ë¡œ classificationê³¼ bounding box regressionì„ ì ìš©í•´ì„œ ê°ê°ì˜ lossë¥¼ ì–»ì–´ë‚´ê³  ì´ë¥¼ ì—­ì „íŒŒí•˜ì—¬ ì „ì²´ ëª¨ë¸ì„ í•™ìŠµì‹œí‚¤ëŠ” ê³¼ì •ì´ ë‚¨ì•˜ë‹¤. ì´ë•Œ classificationê³¼ BBRì„ ì ì ˆí•˜ê²Œ ì—®ì–´ì£¼ëŠ” lossê°€ í•„ìš”í•œë°, ì´ë¥¼ mulit task lossë¼ê³  í•œë‹¤. ìˆ˜ì‹ì€ ì•„ë˜ì™€ ê°™ë‹¤.

![frcnn2](https://user-images.githubusercontent.com/77332628/206882256-b4a41b20-07ea-47f6-96a3-e3918be9e02a.png)

ì•ì˜ ë‘ê°œ pì™€ uëŠ” classificationê³¼ ê´€ë ¨ëœ ì¸ìì¸ë°, pëŠ” softmaxë¥¼ í†µí•´ ì–»ì–´ë‚¸ K+1ê°œì˜(Kê°œì˜ object + 1ê°œì˜ ì•„ë¬´ ë¬¼ì²´ë„ ì•„ë‹˜ì„ ë‚˜íƒ€ë‚´ëŠ” í´ë˜ìŠ¤) í™•ë¥ ê°’ì´ê³ , uëŠ” RoIì˜ ground truth label ê°’ì´ë‹¤.

![frcnn4](https://user-images.githubusercontent.com/77332628/206882257-3cc11860-a2b0-488a-a11e-7658b953d5cb.png)

classification lossëŠ” ë‹¤ìŒê³¼ ê°™ì´ log lossë¥¼ ì‚¬ìš©í•œë‹¤.

![frcnn5](https://user-images.githubusercontent.com/77332628/206882258-71d05b29-3cc8-45dc-b10d-d185e7de6794.png)

ê·¸ ë‹¤ìŒ BBRì„ ì ìš©í•˜ë©´ K+1ê°œì˜ í´ë˜ìŠ¤ì— ëŒ€í•´ ê°ê° x,y,w,hë¥¼ ì¡°ì •í•˜ëŠ” tkê°’ì„ ë¦¬í„°í•˜ëŠ”ë°, ì´ëŠ” RoIê°€ íŠ¹ì • í´ë˜ìŠ¤ì¼ ê²½ìš° RoIë¥¼ ì–´ë–»ê²Œ ì¡°ì ˆí•˜ë¼ëŠ” ê°’ì´ë‹¤. lossì—ì„œëŠ” ì´ ê°’ë“¤ ê°€ìš´ë° ground truth labelì— í•´ë‹¹í•˜ëŠ” ê°’ë§Œ ì‚¬ìš©í•˜ë©° ì´ëŠ” 3ë²ˆì§¸ ê°’ì¸ tuì´ë‹¤. 4ë²ˆì§¸ ê°’ì¸ vëŠ” ground truth bounding box ì¡°ì ˆ ê°’ì— í•´ë‹¹í•œë‹¤. ì•„ë˜ëŠ” tuê°’ì— ëŒ€í•œ ì‹ì´ë‹¤.

![frcnn6](https://user-images.githubusercontent.com/77332628/206882259-23166261-5ecc-4d64-bbca-88dddd8f7baa.png)

BBRì„ í†µí•´ ì–»ëŠ” lossëŠ” ë‹¤ìŒê³¼ ê°™ì´ smoothL1ì´ë¼ëŠ” í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ”ë°, ì…ë ¥ìœ¼ë¡œëŠ” ì •ë‹µ labelì— í•´ë‹¹í•˜ëŠ” BBR ì˜ˆì¸¡ê°’ê³¼ ground truth ì¡°ì ˆ ê°’ì„ ë°›ëŠ”ë‹¤.

![frcnn7](https://user-images.githubusercontent.com/77332628/206882260-2d134ec1-c659-4ac3-ba4c-497971583944.png)

x,y,w,h ê°ê°ì— ëŒ€í•´ì„œ ì˜ˆì¸¡ ê°’ê³¼ ì •ë‹µ ê°’ì˜ ì°¨ì´ë¥¼ ê³„ì‚°í•œ í›„ smoothL1 í•¨ìˆ˜ë¥¼ í†µê³¼ì‹œí‚¨í›„ í•©ì„ ê³„ì‚°í•œë‹¤. smoothL1 í•¨ìˆ˜ëŠ” ë‹¤ìŒê³¼ ê°™ì€ë° ì´ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ” ì‹¤í—˜ ê³¼ì •ì—ì„œ ì •ë‹µ ê°’ê³¼ ì˜ˆì¸¡ê°’ì´ ì§€ë‚˜ì¹˜ê²Œ ì°¨ì´ê°€ ë§ì´ ë‚˜ëŠ” ì´ìƒì¹˜ê°€ ë°œìƒí–ˆê³ , ì´ë“¤ì„ ê·¸ëŒ€ë¡œ L2 distance(0.5x^2)ë¡œ ê³„ì‚°í•˜ë©´ gradientê°€ explode í•´ë²„ë¦¬ëŠ” í˜„ìƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•œ ê²ƒì´ë¼ê³  í•œë‹¤.

![frcnn8](https://user-images.githubusercontent.com/77332628/206882261-c69b8f71-6564-47aa-9668-f9dfb3671b21.png)

### 3. Training Fast R-CNN
í•˜ë‚˜ì˜ ì´ë¯¸ì§€ê°€ ì…ë ¥ë˜ì—ˆì„ ë•Œë¥¼ ê°€ì •í•˜ê³  ì „ì²´ í•™ìŠµ ê³¼ì •ì„ ì•Œì•„ë³´ë„ë¡ í•œë‹¤.

![frcnn9](https://user-images.githubusercontent.com/77332628/206882263-6efb0141-515b-4f41-9073-5565ce1a95cf.png)

1) Initializing pre-trained CNN

feature mapì„ ì¶”ì¶œí•  VGG16 ëª¨ë¸ì„ ì‚¬ìš©í• ê±´ë°, ë¨¼ì € ë„¤íŠ¸ì›Œí¬ë¥¼ detection taskì— ë§ê²Œ ë³€í˜•í•œë‹¤. 
1. VGG16ì˜ ë§ˆì§€ë§‰ max pooling layerë¥¼ RoI pooling layerë¡œ ëŒ€ì²´í•œë‹¤. RoI poolingì„ í†µí•´ ì¶œë ¥ë˜ëŠ” feature mapì˜ í¬ê¸°ëŠ” fc layerì™€ í˜¸í™˜ë˜ë¡œë… 7x7ë¡œ ì„¤ì •í•œë‹¤.
2. ë„¤íŠ¸ì›Œí¬ì˜ ë§ˆì§€ë§‰ fc layerë¥¼ 2ê°œì˜ fc layerë¡œ ëŒ€ì²´í•œë‹¤. ì²« ë²ˆì§¸ fc layerëŠ” {K(Kê°œì˜ class)+1(ë°°ê²½)}ê°œì˜ output unitì„ ê°€ì§€ëŠ” Classifierì´ë©°, ë‘ ë²ˆì§¸ fc layerëŠ” ê° classë³„ë¡œ bounding boxì˜ ì¢Œí‘œë¥¼ ì¡°ì •í•˜ì—¬ (K+1) * 4ê°œì˜ output unitì„ ê°€ì§€ëŠ” bounding box regressorì´ë‹¤.

![frcnn10](https://user-images.githubusercontent.com/77332628/206882265-cc780e9d-ca18-4ea9-b683-017e35838d07.jpeg)

3. ìœ„ì˜ ì´ë¯¸ì§€ì²˜ëŸ¼ conv layer3ê¹Œì§€ì˜ ê°€ì¤‘ì¹˜ëŠ” ë™ê²°ì‹œí‚¤ê³  ì´í›„ layerê¹Œì§€ì˜ ê°€ì¤‘ì¹˜ê°€ í•™ìŠµë  ìˆ˜ ìˆë„ë¡ fine tuningí•´ì¤€ë‹¤. 
4. ë„¤íŠ¸ì›Œí¬ê°€ ì›Œë³¸ ì´ë¯¸ì§€ì™€ selective searchë¥¼ í†µí•´ ì¶”ì¶œëœ region proposals ì§‘í•©ì„ ì…ë ¥ìœ¼ë¡œ ë°›ì„ ìˆ˜ ìˆë„ë¡ ë³€í™˜ì‹œí‚¨ë‹¤.

2) Selective Search
* Input : ì›ë³¸ ì´ë¯¸ì§€
* Process : Selective search
* Output : 2000ê°œì˜ region proposals

3) VGG16

* Input : 224x224x3 sized image
* Process : feature extraction by VGG16
* Output : 14x14x512 feature maps

4) RoI Pooling

![frcnn11](https://user-images.githubusercontent.com/77332628/206882266-d23b7805-3574-4e41-b904-c2ac07a5bd89.png)

(2)ì—ì„œ ì–»ì€ region proposalsì„ VGG16ì„ í†µí•´ ì¶œë ¥ëœ feature mapì— ëŒ€í•´ RoI projectionì„ ì§„í–‰í•œ í›„, RoI Poolingì„ ì§„í–‰í•œë‹¤. (1)ì—ì„œ ì–¸ê¸‰í–ˆë“¯ì´, RoI pooling layerëŠ” VGG16ì˜ ë§ˆì§€ë§‰ pooling layerì„ ëŒ€ì²´í•œ ê²ƒì´ë‹¤.
* Input : 14x14x512 feature maps, 2000 region proposals
* Process : RoI pooling
* Output : 7x7x512 feature maps

5) FC layers

![frcnn12](https://user-images.githubusercontent.com/77332628/206882267-29593a38-4ec7-45ed-8164-d88c261cf2d8.png)

* Input : 7x7x512 feature maps
* Process : feature extraction by fc layers
* Output : 4096 sized feature vector

5-1) Classifier

* Input : 4096 sized feature vector
* Process : í•˜ë‚˜ì˜ ì´ë¯¸ì§€ì—ì„œ í•˜ë‚˜ì˜ region proposalsì— ëŒ€í•œ class prediction
* Output : (K+1) sized vector (class score)

5-2) Bounding Box Regressor

* Input : 4096 sized feature vector
* Process : í•˜ë‚˜ì˜ ì´ë¯¸ì§€ì—ì„œ í•˜ë‚˜ì˜ region proposalsì— ëŒ€í•œ classë³„ë¡œ ì¡°ì •ëœ bounding box ì¢Œí‘œ ì¶œë ¥
* Output : (K+1) * 4 sized vector

6) Train Classifier and BBR by Multi-task loss
* Input : (K+1) sized vector, (K+1) * 4 sized vector
* Process : calculate loss by Multi-task loss function
* Output : loss (Log loss + Smooth L1 loss)

### 4. Detection Fast RCNN

![frcnn13](https://user-images.githubusercontent.com/77332628/206882377-b859d2a4-f0c0-441c-b5f9-e54efa10b0dc.png)

Detection ê³¼ì •ì€ train ê³¼ì •ê³¼ í¬ê²Œ ë‹¤ë¥´ì§€ëŠ” ì•Šì§€ë§Œ 4096í¬ê¸°ì˜ feature vectorë¥¼ ì¶”ì¶œí•˜ëŠ” fc layerì— Truncated SVD(ì†ë„ë¥¼ ë†’ì´ëŠ” ê¸°ë²•, ì´ ê¸€ì—ì„œëŠ” ìƒëµ)ì„ ì ìš©í•˜ê³  ì˜ˆì¸¡í•œ bounding boxì— Non Maximum Suppressionì„ ì¶”ê°€ë¡œ ì ìš©í•´ì„œ ìµœì ì˜ bounding boxë§Œì„ ì¶œë ¥í•œë‹¤.

ì°¸ê³ ìë£Œ

Fast RCNN ë…¼ë¬¸ (https://arxiv.org/pdf/1504.08083.pdf)

ê°œì¸ ë¸”ë¡œê·¸ (https://herbwood.tistory.com/8)


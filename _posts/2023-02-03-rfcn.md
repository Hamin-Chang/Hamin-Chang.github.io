---
title : '[OD/ê°œë…] ê°ì²´ íƒì§€ - R-FCN ğŸ“Œ'
layout : single
toc : true
toc: true
toc_sticky: true
categories:
  - cv-objectdetection
---

## R-FCN ë…¼ë¬¸ (Object Detection via Region-based Fully Convolutional Networks) ì½ì–´ë³´ê¸°

### 1.  Translation invariance Dilemma

ì¼ë°˜ì ìœ¼ë¡œ 2-stage detectorëŠ” ì„œë¡œ ë‹¤ë¥¸ taskë¥¼ ìˆ˜í–‰í•˜ëŠ” ë‘ sub-network ê°„ì— ì£¼ë¡œ í•™ìŠµí•˜ëŠ” ì†ì„±ì—ì„œ ì°¨ì´ê°€ ë°œìƒí•˜ëŠ”ë° ì´ë¥¼ translation invariance dilemmaë¼ê³  í•œë‹¤.

![1](https://user-images.githubusercontent.com/77332628/216543585-b3e433b4-894b-46d9-a7c8-e203e68422e2.png)

ë¨¼ì € **Translation invariance**ëŠ” ì…ë ¥ê°’ì˜ ìœ„ì¹˜ê°€ ë³€í•´ë„ ì¶œë ¥ê°’ì€ ë™ì¼í•œ ê²½ìš°ì— í•´ë‹¹í•˜ëŠ” í•¨ìˆ˜ì˜ ì†ì„±ì´ë‹¤. ìœ„ì˜ ì´ë¯¸ì¹˜ì²˜ëŸ¼ ì„ìƒì˜ ìœ„ì¹˜ê°€ ë‹¬ë¼ì ¸ë„ íŠ¹ì • ëª¨ë¸ì´ ë™ì¼í•˜ê²Œ ì„ìƒì´ë¼ê³  ì¸ì‹í•˜ë©´ í•´ë‹¹ ëª¨ë¸ì€ translation invarianceí•œ ì†ì„±ì„ ê°€ì§€ê³  í•  ìˆ˜ ìˆë‹¤. ë°˜ëŒ€ë¡œ ì…ë ¥ê°’ì˜ ìœ„ì¹˜ê°€ ë³€í•˜ë©´ ì¶œë ¥ê°’ì´ ë‹¬ë¼ì§ˆ ê²½ìš°ì—ëŠ” ì´ë¥¼ **translation variance**í•œ ì†ì„±ì„ ê°€ì§€ê³  ìˆë‹¤ê³  í•  ìˆ˜ ìˆë‹¤.

ì¼ë°˜ì ìœ¼ë¡œ Image classification ëª¨ë¸ì€ translation invariance ì†ì„±ì„ ì„ í˜¸í•˜ëŠ” ë°˜ë©´, Object detection ëª¨ë¸ì€ ê°ì²´ì˜ ìœ„ì¹˜ê°€ ë³€í•˜ë©´ ì´ëŸ¬í•œ ë³€í™”ë¥¼ ì˜ í¬ì°©í•˜ëŠ” ê²ƒì´ ë°”ëŒì§í•˜ê¸° ë•Œë¬¸ì— translation variance ì†ì„±ì„ ì¤‘ìš”ì‹œí•œë‹¤.

2-stage detectorì€ featureë¥¼ ì¶”ì¶œí•˜ëŠ” ì—­í• ì„ ìˆ˜í–‰í•˜ëŠ” backbone networkì™€ detectionì„ ìˆ˜í–‰í•˜ëŠ” networkë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤. ê·¸ ì¤‘ backbone networkëŠ” image classification taskë¥¼ ìœ„í•´ pre-trained ë˜ì–´ìˆë‹¤. ì¦‰ ì›ë³¸ ì´ë¯¸ì§€ë¥¼ backbone networkì— ì…ë ¥í•´ì„œ ì–»ì€ feature mapì€ translation invarianceí•œ ì†ì„±ì„ ë„ê³  ìˆë‹¤. ë°˜ë©´ detectionì„ ìˆ˜í–‰í•˜ëŠ” networkëŠ” translation varianceí•œ ì†ì„±ì„ ê°€ì§„ë‹¤. í•˜ì§€ë§Œ  ì›ë³¸ ì´ë¯¸ì§€ë¥¼ backbone networkì— ì…ë ¥í•´ì„œ ì–»ì€ feature mapì€ ìœ„ì¹˜ ì •ë³´ê°€ ì†Œì‹¤ëœ ì±„ë¡œ detection networkë¡œ ì…ë ¥ëœë‹¤. ë‹¹ì—°í•˜ê²Œë„ detection networkëŠ” ê°ì²´ì— ëŒ€í•œ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ëŠ” feature mapì´ ì…ë ¥ë˜ì–´ì„œ í•™ìŠµì´ ì œëŒ€ë¡œ ì´ë¤„ì§€ì§€ ì•ŠëŠ”ë‹¤.

ì´ì²˜ëŸ¼ ë‘ networkê°„ì— ì¶©ëŒì´ ë°œìƒí•˜ëŠ” ê²½ìš°ë¥¼ **translation invariance dilemma**ë¼ê³  í•˜ë©°, ì´ë¡œ ì¸í•´ mAP ê°’ì´ í•˜ë½í•˜ê²Œ ëœë‹¤.

### 2. Main Ideas

ResNet ë…¼ë¬¸ì˜ ì €ìëŠ” translation invariance dilemmaë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ìœ„ ì´ë¯¸ì§€ì²˜ëŸ¼ ResNet + Faster R-CNN ëª¨ë¸ì˜ ë‘ conv layer ì‚¬ì´ì— RoI poolingì„ ì‚½ì…í•´ì„œ region specificí•œ ì—°ì‚°ì„ ì¶”ê°€í–ˆë‹¤.  í•˜ì§€ë§Œ ë³¸ ë…¼ë¬¸ì˜ ì €ìëŠ” ResNet + Faster R-CNN ëª¨ë¸ê³¼ ê°™ì€ ë°©ë²•ì„ ì‚¬ìš©í•˜ë©´ ëª¨ë“  RoIë¥¼ ê°œë³„ì ìœ¼ë¡œ conv, fc layerì— ì…ë ¥í•˜ê¸° ë•Œë¬¸ì— í•™ìŠµê³¼ ì¶”ë¡ ì˜ ì†ë„ê°€ ëŠë ¤ì§„ë‹¤ëŠ” ì ì„ ì§€ì í•˜ê³  ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ **R-FCN ëª¨ë¸ì€ RPNì„ í†µí•´ ì¶”ì¶œí•œ RoIë¼ë¦¬ ì—°ì‚°ì„ ê³µìœ í•˜ë©´ì„œ ê°ì²´ì˜ ìœ„ì¹˜ì— ëŒ€í•œ ì •ë³´ë¥¼ í¬í•¨í•œ feature mapì„ ì‚¬ìš©í•˜ëŠ” êµ¬ì¡°**ë¥¼ ì‚¬ìš©í•œë‹¤.




### 2.1 Backbone Network

R-FCN ëª¨ë¸ì€ backbone networkë¡œ ResNet-101 networkë¥¼ ì‚¬ìš©í•œë‹¤. ë…¼ë¬¸ì˜ ì €ìëŠ” pre-trainedëœ ResNet-101 ëª¨ë¸ì˜ average pooling layerì™€ fc layerë¥¼ ì œê±°í•˜ê³  ì˜¤ì§ conv layerë§Œìœ¼ë¡œ feature mapì„ ì—°ì‚°í•˜ë„ë¡ í•™ìŠµì‹œí‚¨ë‹¤. ë§ˆì§€ë§‰ feature mapì˜ channelì€ 2048-dì´ë©°, 1x1 conv ì—°ì‚°ì„ ì ìš©í•´ì„œ channel ìˆ˜ë¥¼ 1024-dë¡œ ì¤„ì¸ë‹¤.

### 2.2 Position sensitive score maps & Position sensitive RoI pooling
![3](https://user-images.githubusercontent.com/77332628/216543598-b2b3e16d-d186-407f-90ec-400d41df7f51.jpeg)

ë¨¼ì € RPNì„ í†µí•´ì„œ ì–»ì€ ê°ê°ì˜ RoIì— ëŒ€í•´ì„œ classë³„ë¡œ ìœ„ì¹˜ ì •ë³´ë¥¼ encodeí•˜ê¸° ìœ„í•´ì„œ $k * k$ë¡œ gridë¡œ ë‚˜ëˆ ì¤€ë‹¤. RoIì˜ í¬ê¸°ê°€ $w$ x $h$ì´ë©´, ê° êµ¬ê°„ì˜ í¬ê¸°ëŠ” $\frac{w}k$ x $\frac{h}k$ì´ë‹¤. ë…¼ë¬¸ì—ì„œëŠ” $k=3$ìœ¼ë¡œ ì§€ì •í–ˆë‹¤.

![4](https://user-images.githubusercontent.com/77332628/216543601-dc1ab6b6-a35f-40fe-87d9-78b05c2f8f8c.png)

Backbone networkì—ì„œ ì–»ì€ feature mapì˜ channel ìˆ˜ê°€ $k^2(C+1)$ì´  ë˜ë„ë¡ ë§ˆì§€ë§‰ conv ì—°ì‚°ì„ ì ìš©í•´ì„œ **Position-sensitive score map**ë¥¼ ìƒì„±í•œë‹¤. ì—¬ê¸°ì„œ $C$ëŠ” classìˆ˜ ì´ê³  $k=3$ë¡œ ì§€ì •í–ˆê¸° ë•Œë¬¸ì— position-sensitive score mapì€ classë³„ë¡œ ìœ„ì¹˜ì •ë³´ì¸ {top-left, top-center, top-right, ..., bottom-right}ì— í•´ë‹¹í•˜ëŠ” ì •ë³´ë¥¼ encodeí•˜ê³  ìˆë‹¤. Position-sensitive score mapê³¼ RoIë¥¼ í™œìš©í•´ì„œ $(i,j)$ë²ˆì§¸ êµ¬ê°„ì—ì„œ ì˜¤ì§  $(i,j)$ë²ˆì§¸ score mapë§Œ poolingí•˜ëŠ” **Position-sensitive RoI Pooling**ì„ ìˆ˜í–‰í•œë‹¤. poolingì˜ ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

![5](https://user-images.githubusercontent.com/77332628/216543605-dbd56bb9-75c3-4982-b4d8-7ef6b13a346e.png)

* $r_c(i,j)$ : $C$ë²ˆì§¸ classì˜ $(i,j)$ë²ˆì§¸ êµ¬ê°„ì˜ ê°’ì´ poolingëœ ê²°ê³¼
* $z_{i,j.c}$ : $k^2(C+1)$ score mapì¤‘ í•˜ë‚˜ì˜ score map
* $(x_0,y_0)$ : RoIì˜ top-left corner
* $n$ : êµ¬ê°„ ë‚´ì˜ í”½ì…€ ìˆ˜
* $Î¸$ : ë„¤íŠ¸ì›Œí¬ ë‚´ì˜ ëª¨ë“  í•™ìŠµ ê°€ëŠ¥í•œ íŒŒë¼ë¯¸í„°

![6](https://user-images.githubusercontent.com/77332628/216543607-8a4185ac-a086-4deb-bc1c-b7a04c7ca4d5.png)

poolingì˜ ê³¼ì •ì„ ê°„ë‹¨í•˜ê²Œ ìƒê°í•˜ë©´ class ë³„ë¡œ $\frac{w}k$ x $\frac{h}k$ë§Œí¼ì˜ RoI gridì— ëŒ€í•´ì„œ average poolinì„ ìˆ˜í–‰í•œ ê²ƒì´ë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤. (ë…¼ë¬¸ì—ì„œëŠ” max poolingë„ ì ìš©í•  ìˆ˜ ìˆë‹¤ê³  í•œë‹¤.) ì´ë¥¼ í†µí•´ì„œ RoIë³„ë¡œ í¬ê¸°ê°€ $k*k$ì´ë©° ì±„ë„ ìˆ˜ê°€ $(C+1)$ì¸ feature map(ìœ„ ì´ë¯¸ì§€ì˜ ìµœìš°ì¸¡ ê·¸ë¦¼)ì´ ìƒì„±ëœë‹¤. 

ì´í›„ classë³„ë¡œ $k*k$ í¬ê¸°ì˜ feature mapì˜ ê° ìš”ì†Œë“¤ì˜ í‰ê· ì„ êµ¬í•œë‹¤. ë…¼ë¬¸ì—ì„œëŠ” ì´ ê³¼ì •ì„ **voting**ì´ë¼ê³  í•œë‹¤. $k=3$ì¼ ê²½ìš°, ì±„ë„ ë³„ë¡œ 9ê°œì˜ ìš”ì†Œì˜ í•©ì˜ í‰ê· ì„ êµ¬í•˜ë©´ ëœë‹¤. ì´ë¥¼ í†µí•´ì„œ $(C+1)$ í¬ê¸°ì˜ feature mapì„ ì–»ì„ ìˆ˜ ìˆê³ , softmax functionì„ í†µí•´ lossë¥¼ ê³„ì‚°í•œë‹¤. ë‹¤ìŒì€ position-sensitive RoI poolingê³¼ votingì˜ ì˜ˆì‹œë‹¤.

![7](https://user-images.githubusercontent.com/77332628/216543610-15b061d1-2466-470f-857b-85c7883adbbb.png)

â†‘ 'person' í´ë˜ìŠ¤ì— ëŒ€í•´ì„œ position-sensitive RoI poolingê³¼ voting ìˆ˜í–‰

![8](https://user-images.githubusercontent.com/77332628/216543613-23810fdb-bd89-4792-b6dd-ce6711502aea.png)

â†‘ RoIê°€ objectì™€ ì •í™•íˆ overlap ë˜ì§€ ì•Šì•˜ì„ ë•Œì˜  position-sensitive RoI poolingê³¼ voting

ë…¼ë¬¸ì—ì„œëŠ” bounding box regression ì—­ì‹œ ë¹„ìŠ·í•œ ë°©ë²•ìœ¼ë¡œ ìˆ˜í–‰í•˜ëŠ”ë°, $k^2(C+1)$-d feature mapì™¸ì—ë„ $4k^2$-d feature mapì„ ì¶”ê°€í•´ì„œ bounding box regressionì„ ìˆ˜í–‰í•œë‹¤. ì´ëŠ” ê¸€ ë’·ë¶€ë¶„ training íŒŒíŠ¸ì—ì„œ ë‹¤ë£¬ë‹¤.



### 3. Loss function

![9](https://user-images.githubusercontent.com/77332628/216543617-e6e9742a-d5a2-4d66-bf3d-c07546dca19d.png)

ì†ì‹¤í•¨ìˆ˜ëŠ” Fast R-CNN ëª¨ë¸ê³¼ ê°™ì´ cross-entropy lossì™€ bounding box regression lossì˜ í•©ìœ¼ë¡œ êµ¬ì„±í•œë‹¤. ì†ì‹¤í•¨ìˆ˜ì—ì„œ $c^*$ì€ RoIì˜ ground truth labelì— í•´ë‹¹í•˜ë©°, IoUë¥¼ ê¸°ì¤€ìœ¼ë¡œ 0.5 ì´ìƒì¼ ê²½ìš°, $c^*=1$, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ $c^*=0$ì´ë‹¤. ë‘ loss ì‚¬ì´ì˜ ê°€ì¤‘ì¹˜ë¥¼ ì¡°ì ˆí•˜ëŠ” balancing parameter $Î»=1$ë¡œ ì„¤ì •í•œë‹¤. ì†ì‹¤í•¨ìˆ˜ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì€ Fast R-CNN ë…¼ë¬¸ ë¦¬ë·°[**ë§í¬**](https://hamin-chang.github.io/cv-objectdetection/frcnn/#2-multi-task-loss)ë¥¼ ì°¸ê³  ë°”ë€ë‹¤. 

### 4. Training

![10](https://user-images.githubusercontent.com/77332628/216543619-05eab8c1-25a5-49e9-ad51-7686eba49a4f.png)

1) feature extraction

* Input : ì›ë³¸ ì´ë¯¸ì§€
* Process : feature extraction by pre-trained ResNet-101
* Output : feature map

2) Position-sensitive score maps ìƒì„±

* Input : feature map
* Process : 3x3x$k^2(C+1)$ conv layer, 3x3x$(4k^2)$ conv layer
* Output : $k^2(C+1)$-d feature map(=position sensitive score map), $4k^2$-d feature map

ì—¬ê¸°ì„œ $4k^2$-d feature mapì€ bounding box regressionì„ ìœ„í•œê±´ë°, RoIì˜ ê° êµ¬ê°„ë³„ë¡œ bounding boxì˜ offsetì´ encode ëœ feature mapì´ë‹¤.

3) Region proposal by RPN

RPN ì •í™•í•œ ë™ì‘ ê³¼ì •ì€ Fast R-CNN ë…¼ë¬¸ ë¦¬ë·°[**ë§í¬**](https://hamin-chang.github.io/cv-objectdetection/frcnn/)ì„ ì°¸ê³ ë°”ë€ë‹¤.

* Input : feature map by ResNet-101
* Process : region proposals
* Output : RoIs

4) Position-sensitive RoI pooling

* Input : $k^2(C+1)$-d feature map(=position sensitive score map), $4k^2$-d feature map, RoIs
* Process : position-sensitive pooling (average pooling)
* Output : $k Ã—k Ã—(C+1)$ feature map, $kÃ—kÃ—4$ feature map

5) Voting

votingì´ë€ feature mapì— ëŒ€í•´ì„œ ë‹¤ìŒ ì´ë¯¸ì§€ì²˜ëŸ¼ ê° ì±„ë„ì˜ ìš”ì†Œë“¤ì˜ í‰ê· ì„ êµ¬í•˜ëŠ” ê³¼ì •ì´ë‹¤.

![11](https://user-images.githubusercontent.com/77332628/216543622-95c83f2a-e731-4db6-862b-39e513f6e8bf.png)


* Input : $k Ã—k Ã—(C+1)$ feature map, $kÃ—kÃ—4$ feature map
* Process : Voting
* Output : $(C+1)$-d feature **vector**, 4-d feature **vector**

6) Train R-FCN network by loss function

ë§ˆì§€ë§‰ìœ¼ë¡œ 5)ì—ì„œ ì–»ì€ feature vectorë¥¼ ì‚¬ìš©í•´ì„œ ê°ê° cross-entropy lossì™€ smooth L1 lossë¥¼ êµ¬í•œ í›„ backward passë¥¼ í†µí•´ì„œ networkë¥¼ í•™ìŠµì‹œí‚¨ë‹¤. ì‹¤ì œ í•™ìŠµì‹œì—ëŠ” RPNê³¼ R-FCNì„ ë²ˆê°ˆì•„ê°€ë©° í•™ìŠµí•˜ëŠ” 4-step alternating training ë°©ì‹ì„ ì‚¬ìš©í–ˆë‹¤.

### 5. Inference & ê²°ë¡ 

ìµœì¢…ì ìœ¼ë¡œ ì–»ì€ ì˜ˆì¸¡ê°’ì— **Non maximum suppression**ì„ ìˆ˜í–‰í•œë‹¤. ì´ ë•Œ NMS threshold = 0.7, IoU threshold = 0.5ë¡œ ì„¤ì •í•œë‹¤.

R-FCN ëª¨ë¸ì€ classë³„ë¡œ ê°ì²´ì˜ ìœ„ì¹˜ ì •ë³´ë¥¼ encodeí•œ position sensitive score & poolingì„ í†µí•´ì„œ translation invariance dilemmaë¥¼ íš¨ê³¼ì ìœ¼ë¡œ í•´ê²°í–ˆë‹¤. ì´ë¥¼ í†µí•´ì„œ ASCAL VOC 2007 ë°ì´í„°ì…‹ì„ ì‚¬ìš©í–ˆì„ ë•Œ, 83.6%ë¼ëŠ” ë†’ì€ mAPê°’ì„ ë³´ì˜€ë‹¤ê³  í•œë‹¤. R-FCN ëª¨ë¸ì€ ì´ë¦„ ê·¸ëŒ€ë¡œ fully convolutional networkì´ë©°, ì˜¤ì§ conv layerë¡œë§Œ êµ¬ì„±ë˜ì–´ ìˆë‹¤. ë˜í•œ position-sensitive pooling ì´í›„ í•™ìŠµ ê°€ëŠ¥í•œ layerê°€ ì—†ê¸° ë•Œë¬¸ì— region-wise ì—°ì‚°ëŸ‰ì´ ë§ì§€ ì•Šì•„(cost free) í•™ìŠµ ë° ì¶”ë¡  ì†ë„ê°€ ë¹ ë¥´ë‹¤ëŠ” ì¥ì ì´ ìˆë‹¤. detection ì‹œ ì´ë¯¸ì§€ í•œ ì¥ë‹¹ ResNet + Faster R-CNN ëª¨ë¸ë³´ë‹¤ 0.5~20ë°° ì´ìƒ ë¹ ë¥¸ ì†ë„ë¥¼ ë³´ì¸ë‹¤ê³  í•œë‹¤.

ì¶œì²˜ ë° ì°¸ê³  ë¬¸í—Œ :

R-FCN ë…¼ë¬¸ https://arxiv.org/pdf/1605.06409.pdf

ê°œì¸ ë¸”ë¡œê·¸ http://herbwood.tistory.com/16

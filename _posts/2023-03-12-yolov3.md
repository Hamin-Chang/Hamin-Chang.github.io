---
title : '[DL/CV] ê°ì²´ íƒì§€ - YOLO v3 ğŸ¤Ÿ'
layout : single
toc : true
toc: true
toc_sticky: true
categories:
  - cv-objectdetection
---

## YOLO v3 ë…¼ë¬¸ ì½ì–´ë³´ê¸°

ì´ë²ˆ ê¸€ì—ì„œëŠ” [<U>YOLO v3 ë…¼ë¬¸</U>](https://arxiv.org/pdf/1804.02767.pdf)ì„ ë¦¬ë·°í•´ë³´ë„ë¡ í•˜ê² ë‹¤. YOLO v3ëŠ” ë‹¹ì‹œì— ìœ í–‰í•˜ë˜ ìƒˆë¡œìš´ ê¸°ë²•ë“¤ì„ ë„ì…í•´ì„œ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¨ ëª¨ë¸ì´ë‹¤. [<U>YOLO v2 ë…¼ë¬¸ ë¦¬ë·° í¬ìŠ¤íŒ…</U>](https://hamin-chang.github.io/cv-objectdetection/yolov2/)ê³¼ ë¹„êµí•˜ë©° ì½ìœ¼ë©´ ë„ì›€ì´ ë  ê²ƒì´ë‹¤. ìƒˆë¡­ê²Œ ë„ì…ëœ ì•„ì´ë””ì–´ë“¤ì„ ìœ„ì£¼ë¡œ ë‹¤ë£¨ê² ë‹¤.

### 1. Bounding box Prediction

![1](https://user-images.githubusercontent.com/77332628/224516888-a5875b2b-d2eb-413f-a9bb-ae4d109e9b38.png)

YOLO v2ëŠ” dimension clusterë¥¼ anchor boxë¡œ ì‚¬ìš©í•´ì„œ bounding boxë¥¼ ì˜ˆì¸¡í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í–ˆë‹¤. ëª¨ë¸ì€ ê° bounding boxì˜ ì¢Œí‘œ ê°’ì¸ $t_x, t_y, t_w, t_h$ë¥¼ ì˜ˆì¸¡í•œë‹¤. ê·¸ë¦¬ê³  ìœ„ì˜ ì´ë¯¸ì§€ì²˜ëŸ¼ ì…€ì˜ ì‹œì‘ ìœ„ì¹˜ë¥¼ $(c_x, c_y)$ë¡œ ì„¤ì •í•˜ê³  , anchor boxì˜ ë„ˆë¹„ì™€ ë†’ì´ë¥¼ $p_w, p_h$ë¡œ ì •í•´ì„œ ë‹¤ìŒ ê³¼ ê°™ì€ ê°’ìœ¼ë¡œ ë³€í™˜í•œ í›„ L2 lossë¥¼ í†µí•´ í•™ìŠµì‹œí‚¨ë‹¤.

<center>$b_x = Ïƒ(t_x) + c_x$</center>

<center>$b_y = Ïƒ(t_y) + c_y$</center>

<center>$b_w = p_we^{t_w}$</center>

<center>$b_h = p_he^{t_h}$</center>

í•˜ì§€ë§Œ YOLO v3ëŠ” ground truth ì¢Œí‘œë¥¼ ìœ„ì˜ ê³µì‹ì„ ê±°ê¾¸ë¡œ ì ìš©ì‹œì¼œì„œ $t_*$ë¡œ ë³€í™˜í•œ í›„ $t_x$ì™€ ì§ì ‘ L1 lossë¥¼ í†µí•´ í•™ìŠµì‹œí‚¤ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ground truth boxì˜ $x$ì¢Œí‘œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë³€í™˜ì‹œí‚¨ë‹¤.

<center>$b_* = Ïƒ(t_*) + c_*$</center>

<center>$Ïƒ(t_*)= b_* - c_*$</center>

<center>$t_* = log(b_* - c_*)$</center>


ë˜í•œ YOLO v3ì€ bounding boxì˜ objectness scoreë„ ì˜ˆì¸¡í•œë‹¤. bboxì™€ ground truthì˜ IoUê°€ ê°€ì¥ ë†’ìœ¼ë©´ 1, ê°€ì¥ ë†’ì§„ ì•Šê³  threshold(=0.5)ê°’ì„ ë„˜ê¸°ë©´ ê·¸ëƒ¥ ë¬´ì‹œí•´ë²„ë ¤ì„œ IoU ê°’ì´ ê°€ì¥ ë†’ì€ bboxë§Œ ë§¤ì¹­ì‹œí‚¨ë‹¤. ground truth boxì— í• ë‹¹ë˜ì§€ ëª»í•œ bboxëŠ” bounding box regression lossë¥¼ ìœ ë°œí•˜ì§€ ì•Šê³ , objectness scoreì— ëŒ€í•œ lossë§Œ ìœ ë°œí•œë‹¤.

### 2. Class Prediction

![2](https://user-images.githubusercontent.com/77332628/224516890-92a112db-ec8a-4f43-846d-b251fb5c041f.png)

[<U>ì´ë¯¸ì§€ ì¶œì²˜</U>](https://kr.mathworks.com/help/deeplearning/ug/multilabel-image-classification-using-deep-learning.html)

YOLO v3ì—ì„œëŠ” ê°ê°ì˜ bounding boxì— ëŒ€í•´ multi-label classificationì„ ìˆ˜í–‰í•œë‹¤. ì—¬ê¸°ì„œ softmax í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ ì„±ëŠ¥ ë©´ì—ì„œ ì¢‹ì§€ ì•Šê¸° ë•Œë¬¸ì— **binary cross-entropy**ë¥¼ ì‚¬ìš©í•œë‹¤ê³  í•˜ëŠ”ë°, ì´ëŸ¬í•œ ë°©ì‹ì€ ë” ë³µì¡í•œ ë°ì´í„°ì…‹ì´ ìˆì„ ë•Œ ìœ ì˜ë¯¸í•œ ê²°ê³¼ë¥¼ ë³´ì—¬ì£¼ê¸° ë•Œë¬¸ì´ë‹¤. ê°€ë ¹ í•˜ë‚˜ì˜ boxì•ˆì— ë³µìˆ˜ì˜ ê°ì²´ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš° softmax í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ classë¥¼ ì˜ˆì¸¡í•˜ë©´ ì ì ˆí•˜ê²Œ í¬ì°©í•˜ì§€ ëª»í•œë‹¤ëŠ” ë¬¸ì œê°€ ìˆë‹¤. ë”°ë¼ì„œ boxì—ì„œ ê° classê°€ ì¡´ì¬í•˜ëŠ” ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” binary cross-entropyê°€ ë³´ë‹¤ ì ì ˆí•˜ë‹¤ê³  í•œë‹¤.



### 3. Predictions Across Scales

YOLO v3ëŠ” 3ê°œì˜ multi-scale feature mapì„ ì‚¬ìš©í•´ì„œ ìµœì¢… ê²°ê³¼ë¥¼ ì˜ˆì¸¡í•˜ëŠ”ë°, **multi-scale feature mapì„ ì–»ëŠ” ë°©ë²•ì€ FPNê³¼ ìœ ì‚¬**í•˜ë‹¤. ë‹¤ìŒ ì´ë¯¸ì§€ì²˜ëŸ¼ 416x416 í¬ê¸°ì˜ ì´ë¯¸ì§€ë¥¼ ë„¤íŠ¸ì›Œí¬ì— ì…ë ¥í•´ì„œ feature mapì˜ í¬ê¸°ê°€ 5**2x52. 26x26, 13x13ì´ ë˜ëŠ” layerì—ì„œ feature mapì„ ì¶”ì¶œ**í•œë‹¤. 

![3](https://user-images.githubusercontent.com/77332628/224516891-60b7e640-7409-46ee-8275-d43aeac86e92.jpeg)

ê·¸ ë‹¤ìŒ ê°€ì¥ ë†’ì€ level(= ê°€ì¥ ë‚®ì€ í•´ìƒë„)ì˜ feature mapì„ 1x1, 3x3 conv layerë¡œ êµ¬ì„±ëœ ì‘ì€ **FCN(Fully Convolutional Network)ì— ì…ë ¥**í•œë‹¤. ì´í›„ FCNì˜ output channelì´ 512ê°€ ë˜ëŠ” ì§€ì ì—ì„œ feature mapì„ ì¶”ì¶œí•˜ê³  **2ë°°ë¡œ upsamplingí•œ ë‹¤ìŒ ë°”ë¡œ ì•„ë˜ levelì˜ feature mapê³¼ concatenate**í•œë‹¤. ì´í›„ í•©ì³ì§„ feature mapì„ FCNì— ì…ë ¥í•œë‹¤. ì´ ê³¼ì •ì„ ë‹¤ìŒ levelì˜ feature mapì— ë˜‘ê°™ì´ ìˆ˜í–‰í•´ì„œ 3ê°œì˜ scaleì„ ê°€ì§„ multi-scale feature mapì„ ì–»ëŠ”ë‹¤. 

ì´ë•Œ ê° scaleì˜ feature mapì˜ output channel ìˆ˜ê°€ [3x(4+1+80)](=255)ê°€ ë˜ë„ë¡ ë§ˆì§€ë§‰ conv layerì˜ channel ìˆ˜ë¥¼ ì¡°ì •í•œë‹¤. ì—¬ê¸°ì„œ 3ì€ grid cellë‹¹ ì˜ˆì¸¡í•˜ëŠ” anchor boxì˜ ìˆ˜, 4ëŠ” bounding box offset, 1ì€ objectness score, 80ì€ COCO ë°ì´í„°ì…‹ì„ ì‚¬ìš©í–ˆì„ ë•Œì˜ class ìˆ˜ì´ë‹¤. ë‹¤ìŒ ì´ë¯¸ì§€ì™€ ê°™ì€ ê³¼ì •ì„ ê±°ì³ì„œ ìµœì¢…ì ìœ¼ë¡œ 52x52(x255), 26x26(x255), 13x13(x255) í¬ê¸°ì˜ feature mapì„ ì–»ì„ ìˆ˜ ìˆë‹¤.

![4](https://user-images.githubusercontent.com/77332628/224516893-e7865cfb-fb69-4289-b29e-e32864e75250.jpeg)

ì´ëŸ¬í•œ ë°©ë²•ì„ ì‚¬ìš©í•˜ë©´ ë” ë†’ì€ levelì˜ feature mapìœ¼ë¡œë¶€í„° **fine-grainedí•œ ì •ë³´**ë¥¼ ì–»ì„ ìˆ˜ ìˆê³ , ë” ë‚®ì€ levelì˜ feature mapìœ¼ë¡œë¶€í„° ë” ìœ ìš©í•œ **semantic ì •ë³´**ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.

### 4. Feature Extractor

![5](https://user-images.githubusercontent.com/77332628/224516894-9e833725-2a51-4295-84e6-aac9ae4e78da.png)

YOLO v3ì—ì„œëŠ” shortcut connectionì´ ì¶”ê°€ë˜ì–´ 53ê°œì˜ layerë¥¼ ê°€ì§€ëŠ” Darknet-53ì„ backbone networkë¡œ ì‚¬ìš©í•œë‹¤. ì´ëŠ” ResNet-101ë³´ë‹¤ 1.5ë°° ë¹ ë¥´ë©°, ResNet-152ì™€ ë¹„ìŠ·í•œ ì„±ëŠ¥ì„ ë³´ì´ì§€ë§Œ 2ë°°ì´ìƒ ë¹ ë¥´ë‹¤. ë˜í•œ ë‹¹ì‹œ ì´ˆë‹¹ ê°€ì¥ ë†’ì€ floating point operation ì†ë„ë¥¼ ë³´ì˜€ëŠ”ë°, ì´ëŠ” GPUë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì‚¬ìš©í•¨ì„ ì˜ë¯¸í•œë‹¤.

### 5. Training YOLO v3

![YOLO v3 architecture](https://user-images.githubusercontent.com/77332628/224516895-e37d4555-2d21-440b-889d-6cc6b515b833.png)


1) feature map by **Darknet-53**

* Input: 416x416 sized image
* Process : extract multi-scale feature maps
* Output : 52x52, 26x26, 13x13 sized feature maps

2) Building **feature pyramid by FCN**

(1)ì—ì„œ ì–»ì€ 3ê°œì˜ feature mapì„ ìœ„ì—ì„œ ì„¤ëª…í•œ ë°©ë²•ìœ¼ë¡œ FCNì— ì…ë ¥í•´ì„œ feature pyramidë¥¼ ì„¤ê³„í•œë‹¤. 

<img width="386" alt="7" src="https://user-images.githubusercontent.com/77332628/224516897-3c32369e-31d5-4f78-a400-1ea3a3d30b7d.png">

* Input: 52x52, 26x26, 13x13 sized feature maps
* Process : building feature pyramid by FCN
* Output : 52x52(x255), 26x26(x255), 13x13(x255) sized feature maps

3) Train YOLO v3 by loss function

ë…¼ë¬¸ì—ì„œëŠ” êµ¬ì²´ì ìœ¼ë¡œ ì–¸ê¸‰í•˜ì§€ëŠ” ì•Šì§€ë§Œ loss functionì€ ë‹¤ìŒ 4ê°œì˜ í•­ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤.

1. bbox offsetì˜ MSE(Mean Squared Error)
2. ê°ì²´ë¥¼ ì˜ˆì¸¡í•˜ë„ë¡ í• ë‹¹ëœ(responsible for) bboxì˜ **objectness scoreì˜ BCE(Binary Cross Entropy)**
3. í• ë‹¹ë˜ì§€ ì•Šì€ bboxì˜ **no objectness scoreì˜ BCE**
4. bboxì˜ **multi-class BCE **

YOLO v2ì—ì„œëŠ” ëª¨ë“  ì˜ˆì¸¡ ê²°ê³¼ì— ëŒ€í•´ MSEë¥¼ ì ìš©í•œ ë°˜ë©´ YOLO v3ëŠ” **BCEë¥¼ ì£¼ë¡œ ì‚¬ìš©**í•œë‹¤.



### 6. Inference & ê²°ë¡ 

Inferece ì‹œì—ëŠ” ë§ˆì§€ë§‰ ì˜ˆì¸¡ ê²°ê³¼ì— ëŒ€í•´ NMS(Non Maximum Suppression)ì„ ì ìš©í•œë‹¤.

![8](https://user-images.githubusercontent.com/77332628/224516900-9cb6cbdd-ad2e-4475-a99d-e5b305baa27b.png)

ìœ„ ê·¸ë˜í”„ì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´ YOLO v3ëŠ” ì„±ëŠ¥ì€ RetinaNetì— ë¹„í•´ì„œëŠ” ì•½ê°„ ë‚®ì§€ë§Œ SSDì™€ ì„±ëŠ¥ì´ ë¹„ìŠ·í•˜ê³  3ë°° ì´ìƒì˜ ë¹ ë¥¸ ì†ë„ë¥¼ ë³´ì˜€ë‹¤. íŠ¹íˆ x,y ì¶•ì„ ëš«ê³  ë‚˜ê°ˆ ì •ë„ë¡œ inference ì†ë„ ë©´ì—ì„œëŠ” í˜ì‹ ì ì¸ ì„±ê³¼ë¥¼ ë³´ì˜€ë‹¤ê³  í•  ìˆ˜ ìˆë‹¤.

ì¶œì²˜ ë° ì°¸ê³ ìë£Œ

ê°œì¸ ë¸”ë¡œê·¸ (https://herbwood.tistory.com/21)

YOLO v3 ë…¼ë¬¸ (https://arxiv.org/pdf/1804.02767.pdf)
